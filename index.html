<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>MarCom System v13.2 (User Management)</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/lodash@4.17.21/lodash.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">

    <script async src="https://www.googletagmanager.com/gtag/js?id=G-5WZMXWHSJE"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      gtag('config', 'G-5WZMXWHSJE');
    </script>

    <script type="importmap">
    {
      "imports": {
        "react": "https://esm.sh/react@18.2.0",
        "react-dom": "https://esm.sh/react-dom@18.2.0",
        "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
        "recharts": "https://esm.sh/recharts@2.12.7?external=react,react-dom",
        "lucide-react": "https://esm.sh/lucide-react@0.330.0",
        "firebase/app": "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js",
        "firebase/firestore": "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js",
        "firebase/auth": "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js"
      }
    }
    </script>

    <style>
        body { font-family: 'Inter', sans-serif; -webkit-tap-highlight-color: transparent; }
        .custom-scrollbar::-webkit-scrollbar { height: 6px; width: 6px; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #94a3b8; border-radius: 10px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: #f1f5f9; }
        
        thead th { position: sticky; top: 0; z-index: 40; background-color: #f8fafc; box-shadow: 0 1px 0px #e2e8f0; }
        .sticky-col-0, .sticky-col-1, .sticky-col-2, .sticky-col-3, .sticky-col-4 { position: sticky; z-index: 30; background-color: white; border-right: 1px solid #e2e8f0; }
        thead th.sticky-col-0, thead th.sticky-col-1, thead th.sticky-col-2, thead th.sticky-col-3, thead th.sticky-col-4 { z-index: 50 !important; background-color: #f8fafc; }

        .sticky-col-0 { left: 0; }
        .sticky-col-1 { left: var(--col-width-check, 40px); }
        .sticky-col-2 { left: calc(var(--col-width-check, 40px) + var(--col-width-actions, 50px)); }
        .sticky-col-3 { left: calc(var(--col-width-check, 40px) + var(--col-width-actions, 50px) + var(--col-width-admin, 140px)); }
        .sticky-col-4 { left: calc(var(--col-width-check, 40px) + var(--col-width-actions, 50px) + var(--col-width-admin, 140px) + var(--col-width-task, 250px)); border-right: 2px solid #94a3b8; }

        tr:hover td.sticky-col-0, tr:hover td.sticky-col-1, tr:hover td.sticky-col-2, tr:hover td.sticky-col-3, tr:hover td.sticky-col-4 { background-color: #f8fafc; }
        tr.bg-indigo-50 td.sticky-col-0, tr.bg-indigo-50 td.sticky-col-1, tr.bg-indigo-50 td.sticky-col-2, tr.bg-indigo-50 td.sticky-col-3, tr.bg-indigo-50 td.sticky-col-4 { background-color: #eef2ff; }

        @media (max-width: 1024px) {
            .sticky-col-0, .sticky-col-1, .sticky-col-2, .sticky-col-3, .sticky-col-4 { position: static !important; border-right: none !important; box-shadow: none !important; }
            th.sticky-col-0, td.sticky-col-0 { width: 40px !important; min-width: 40px !important; max-width: 40px !important; }
        }

        .animate-in { animation-duration: 0.3s; animation-fill-mode: both; }
        .fade-in { animation-name: fadeIn; }
        .zoom-in { animation-name: zoomIn; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes zoomIn { from { transform: scale(0.95); opacity: 0; } to { transform: scale(1); opacity: 1; } }
        .sidebar-transition { transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1); }
        .main-transition { transition: margin-left 0.3s cubic-bezier(0.4, 0, 0.2, 1); }
    </style>
</head>
<body class="bg-[#F1F5F9] text-slate-800 h-screen overflow-hidden">
    <div id="root" class="h-full"></div>

    <script type="text/babel" data-type="module">
        import React, { useState, useEffect, useMemo, useRef, useCallback } from 'react';
        import ReactDOM from 'react-dom';
        import { createRoot } from 'react-dom/client';
        import { initializeApp } from 'firebase/app';
        import { getFirestore, collection, addDoc, setDoc, getDoc, getDocs, onSnapshot, updateDoc, doc, serverTimestamp, deleteDoc, writeBatch, query, orderBy, limit } from 'firebase/firestore';
        import { getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged } from 'firebase/auth';
        import { LayoutDashboard, PlusCircle, Table as TableIcon, Download, Upload, Trash2, CheckCircle2, Clock, AlertCircle, X, ChevronDown, Check, Briefcase, Database, Wand2, BrainCircuit, Sparkles, RefreshCw, Undo2, Menu, ChevronLeft, Calendar, Building2, LogOut, Shield, UserPlus, History, UserCheck } from 'lucide-react';
        import { BarChart, Bar, XAxis, YAxis, Tooltip, ResponsiveContainer, Cell, Legend, PieChart, Pie } from 'recharts';

        const firebaseConfig = {
            apiKey: "AIzaSyDNdBlMZL42nkWc7W1OtgkWvkxKCwxKCjQ",
            authDomain: "marcom-dashboard-test.firebaseapp.com",
            projectId: "marcom-dashboard-test",
            storageBucket: "marcom-dashboard-test.firebasestorage.app",
            messagingSenderId: "840436404750",
            appId: "1:840436404750:web:783b44fa370f94b4dba25f"
        };
        const appId = 'marcom-hub-pro-v12';

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        const DEPARTMENTS = [ "Văn phòng trường", "P. Marketing và Truyền thông", "P. Đào tạo", "P. Hợp tác quốc tế", "K. Công nghệ thông tin", "K. Cơ khí - Cơ điện tử", "K. Điện - Điện tử", "Toàn trường" ];
        const CATEGORIES = ["Thiết kế", "Duyệt thiết kế", "Trực HT", "Đưa tin", "Chụp ảnh", "Hỗ trợ tổ chức sự kiện", "Khác"];
        const OVERALL_STATUS = ["Chờ duyệt", "Gấp", "Chưa bắt đầu", "Đang xử lý", "Hoàn thành"];
        const TASK_STATUS = ["Không có task", "Chưa bắt đầu", "Đang xử lý", "Hoàn thành"];
        const PAPER_STATUS = ["Đã duyệt", "Chưa duyệt", "Hiệu trưởng duyệt", "Nợ tờ trình", "N/A"];
        const STATUS_COLOR_MAP = { "Chờ duyệt": "#a855f7", "Gấp": "#ef4444", "Chưa bắt đầu": "#94a3b8", "Đang xử lý": "#6366f1", "Hoàn thành": "#10b981", "Không có task": "#cbd5e1" };
        const TEAM_COLORS = { brand: "#8b5cf6", operation: "#f97316", media: "#0ea5e9" };

        const MultiSelectModal = ({ options, selected, onChange, inline = false }) => {
            const [isOpen, setIsOpen] = useState(false);
            const handleToggle = (option) => onChange(selected.includes(option) ? selected.filter(i => i !== option) : [...selected, option]);
            return (
                <div className="w-full">
                    <div onClick={() => setIsOpen(true)} className={`w-full px-2 py-1.5 rounded border border-slate-300 bg-white flex items-center justify-between cursor-pointer hover:border-indigo-500 transition-all ${inline ? 'text-[10px] min-h-[30px]' : 'px-5 py-4 rounded-2xl bg-slate-50'}`}>
                        <div className="flex flex-wrap gap-1 w-[90%] overflow-hidden h-full">{selected.length === 0 ? <span className="text-slate-400 italic">-- Chọn --</span> : selected.map(item => <span key={item} className="bg-indigo-100 text-indigo-700 text-[9px] px-1.5 py-0.5 rounded font-bold border border-indigo-200 whitespace-nowrap">{item}</span>)}</div><ChevronDown size={12} className="text-slate-400 shrink-0 ml-1"/>
                    </div>
                    {isOpen && ReactDOM.createPortal(<div className="fixed inset-0 z-[10000] flex items-center justify-center p-4 bg-slate-900/60 backdrop-blur-sm animate-in fade-in" onClick={() => setIsOpen(false)}><div className="bg-white rounded-3xl shadow-2xl w-full max-w-md p-6 animate-in zoom-in" onClick={e => e.stopPropagation()}><div className="flex justify-between items-center mb-6 border-b border-slate-100 pb-4"><h3 className="text-lg font-black text-slate-800 uppercase">Phân loại</h3><button onClick={() => setIsOpen(false)}><X size={20}/></button></div><div className="grid grid-cols-2 gap-3 max-h-[50vh] overflow-y-auto custom-scrollbar p-1">{options.map(o => (<div key={o} onClick={() => handleToggle(o)} className={`flex items-center gap-3 px-4 py-3 rounded-xl border-2 cursor-pointer ${selected.includes(o) ? 'border-indigo-600 bg-indigo-50 font-bold' : 'border-slate-100'}`}><div className={`w-5 h-5 rounded border flex items-center justify-center ${selected.includes(o) ? 'bg-indigo-600 border-indigo-600' : 'border-slate-300'}`}>{selected.includes(o) && <Check size={14} className="text-white"/>}</div><span className="text-xs">{o}</span></div>))}</div><div className="mt-6 pt-4 border-t flex justify-end"><button onClick={() => setIsOpen(false)} className="px-6 py-3 bg-indigo-600 text-white rounded-xl font-bold">Xong</button></div></div></div>, document.body)}
                </div>
            );
        };

        const LoginScreen = () => {
            const [email, setEmail] = useState('');
            const [password, setPassword] = useState('');
            const [error, setError] = useState('');
            const [loading, setLoading] = useState(false);
            const handleSubmit = async (e) => {
                e.preventDefault(); setLoading(true); setError('');
                try { await signInWithEmailAndPassword(auth, email, password); }
                catch (err) { setError("Sai tài khoản hoặc mật khẩu."); }
                finally { setLoading(false); }
            };
            return (
                <div className="min-h-screen flex items-center justify-center bg-slate-100 p-6">
                    <div className="bg-white p-10 rounded-[2.5rem] shadow-2xl w-full max-w-md animate-in zoom-in">
                        <div className="flex justify-center mb-6"><div className="w-16 h-16 bg-indigo-600 rounded-2xl flex items-center justify-center shadow-lg"><Briefcase size={32} className="text-white"/></div></div>
                        <h2 className="text-2xl font-black text-center text-slate-900 mb-8 uppercase tracking-tighter">MarCom Portal Login</h2>
                        {error && <div className="bg-rose-50 text-rose-600 p-3 rounded-xl text-xs font-bold mb-4">{error}</div>}
                        <form onSubmit={handleSubmit} className="space-y-4">
                            <div><label className="text-xs font-bold text-slate-500 uppercase">Email</label><input type="email" required className="w-full p-4 bg-slate-50 rounded-xl border border-slate-200 outline-none focus:border-indigo-500 font-bold" value={email} onChange={e => setEmail(e.target.value)} /></div>
                            <div><label className="text-xs font-bold text-slate-500 uppercase">Mật khẩu</label><input type="password" required className="w-full p-4 bg-slate-50 rounded-xl border border-slate-200 outline-none focus:border-indigo-500 font-bold" value={password} onChange={e => setPassword(e.target.value)} /></div>
                            <button disabled={loading} className="w-full py-4 bg-indigo-600 text-white rounded-xl font-bold hover:bg-indigo-700 shadow-lg shadow-indigo-200 transition-all">{loading ? 'Đang xác thực...' : 'Đăng nhập'}</button>
                        </form>
                    </div>
                </div>
            );
        };

        function App() {
            const [user, setUser] = useState(null);
            const [role, setRole] = useState('editor');
            const [activeTab, setActiveTab] = useState('dashboard');
            const [tasks, setTasks] = useState([]);
            const [logs, setLogs] = useState([]);
            const [usersList, setUsersList] = useState([]);
            const [sidebarOpen, setSidebarOpen] = useState(true);
            const [isMobile, setIsMobile] = useState(window.innerWidth < 1024);
            const [selectedIds, setSelectedIds] = useState([]);
            const [toast, setToast] = useState(null);

            const [colFilters, setColFilters] = useState({ date: '', ticket: '', task: '', overall: '', unit: '' });
            const [globalFilters, setGlobalFilters] = useState({ dateStart: '', dateEnd: '', unit: '', category: '' });

            // LOGGING
            const logAction = async (action, details) => {
                try {
                    await addDoc(collection(db, 'artifacts', appId, 'admin_data', 'logs'), {
                        timestamp: serverTimestamp(),
                        user: user.email,
                        action: action,
                        details: JSON.stringify(details)
                    });
                } catch(e) { console.error(e); }
            };

            // AUTH & ROLE
            useEffect(() => {
                return onAuthStateChanged(auth, async (u) => {
                    if (u) {
                        setUser(u);
                        const userRef = doc(db, 'artifacts', appId, 'admin_data', 'users', u.email);
                        const snap = await getDoc(userRef);
                        if (snap.exists()) {
                            setRole(snap.data().role);
                        } else {
                            // First user logic: If no users exist, make first one admin
                            const allUsers = await getDocs(collection(db, 'artifacts', appId, 'admin_data', 'users'));
                            const newRole = allUsers.empty ? 'admin' : 'editor';
                            await setDoc(userRef, { role: newRole, email: u.email });
                            setRole(newRole);
                        }
                    } else { setUser(null); }
                });
            }, []);

            // DATA SYNC
            useEffect(() => {
                if (!user) return;
                const unsubTasks = onSnapshot(collection(db, 'artifacts', appId, 'public', 'data', 'marcom_v11_tasks'), (sn) => {
                    setTasks(sn.docs.map(d => ({ id: d.id, ...d.data() })).sort((a, b) => new Date(b.orderDate) - new Date(a.orderDate)));
                });
                let unsubLogs = () => {}, unsubUsers = () => {};
                if (role === 'admin') {
                    unsubLogs = onSnapshot(query(collection(db, 'artifacts', appId, 'admin_data', 'logs'), orderBy('timestamp', 'desc'), limit(50)), (sn) => setLogs(sn.docs.map(d => ({ id: d.id, ...d.data() }))));
                    unsubUsers = onSnapshot(collection(db, 'artifacts', appId, 'admin_data', 'users'), (sn) => setUsersList(sn.docs.map(d => ({ id: d.id, ...d.data() }))));
                }
                return () => { unsubTasks(); unsubLogs(); unsubUsers(); };
            }, [user, role]);

            const handleUpdateTask = (id, data) => {
                updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'marcom_v11_tasks', id), data);
                logAction('UPDATE_TASK', { id, data });
            };

            const handleDeleteTask = async (id) => {
                if (role !== 'admin') return alert("Chỉ Admin mới được xóa!");
                await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'marcom_v11_tasks', id));
                logAction('DELETE_TASK', { id });
            };

            const handleRoleChange = async (email, newRole) => {
                if (role !== 'admin') return;
                await updateDoc(doc(db, 'artifacts', appId, 'admin_data', 'users', email), { role: newRole });
                logAction('CHANGE_ROLE', { target: email, role: newRole });
            };

            // CHARTS
            const filteredTasks = useMemo(() => tasks.filter(t => {
                const dateG = (!globalFilters.dateStart || t.orderDate >= globalFilters.dateStart) && (!globalFilters.dateEnd || t.orderDate <= globalFilters.dateEnd);
                const unitG = !globalFilters.unit || t.unit === globalFilters.unit;
                const dateC = !colFilters.date || t.orderDate.includes(colFilters.date);
                const taskC = !colFilters.task || t.taskName.toLowerCase().includes(colFilters.task.toLowerCase());
                const unitC = !colFilters.unit || t.unit.toLowerCase().includes(colFilters.unit.toLowerCase());
                const overallC = !colFilters.overall || t.overallStatus === colFilters.overall;
                return dateG && unitG && dateC && taskC && unitC && overallC;
            }), [tasks, globalFilters, colFilters]);

            const chartOverall = useMemo(() => OVERALL_STATUS.map(s => ({ name: s, value: filteredTasks.filter(t => t.overallStatus === s).length })), [filteredTasks]);
            const teamStats = (key) => TASK_STATUS.map(s => ({ name: s, value: tasks.filter(t => t[`${key}Task`]?.status === s).length }));

            if (!user) return <LoginScreen />;

            return (
                <div className="flex h-full overflow-hidden bg-[#F1F5F9]">
                    {/* SIDEBAR */}
                    <aside className={`sidebar-transition fixed inset-y-0 left-0 z-[100] bg-[#0F172A] text-white w-64 ${sidebarOpen ? 'translate-x-0' : '-translate-x-full'}`}>
                        <div className="p-8 border-b border-slate-800 flex items-center gap-3">
                            <div className="w-10 h-10 bg-indigo-600 rounded-xl flex items-center justify-center shadow-lg"><Briefcase size={24}/></div>
                            <div className="flex flex-col"><span className="font-black text-lg leading-none">MarCom</span><span className="text-[10px] text-slate-400 uppercase tracking-widest font-bold">Portal v13.2</span></div>
                        </div>
                        <nav className="p-4 space-y-2">
                            {[{ id: 'dashboard', label: 'Dashboard', icon: LayoutDashboard }, { id: 'input', label: 'Tạo công việc', icon: PlusCircle }, { id: 'list', label: 'Danh sách', icon: TableIcon }].map(tab => (
                                <button key={tab.id} onClick={() => setActiveTab(tab.id)} className={`w-full flex items-center gap-4 px-5 py-4 rounded-xl transition-all ${activeTab === tab.id ? 'bg-indigo-600 shadow-lg font-bold' : 'text-slate-400 hover:bg-slate-800 hover:text-white'}`}><tab.icon size={18}/> {tab.label}</button>
                            ))}
                            {role === 'admin' && <button onClick={() => setActiveTab('admin')} className={`w-full flex items-center gap-4 px-5 py-4 rounded-xl transition-all ${activeTab === 'admin' ? 'bg-indigo-600 shadow-lg font-bold' : 'text-slate-400 hover:bg-slate-800 hover:text-white'}`}><Shield size={18}/> Quản trị</button>}
                        </nav>
                        <div className="absolute bottom-0 w-full p-4 border-t border-slate-800">
                            <div className="flex items-center gap-3 px-4 py-2 mb-2 bg-slate-800/50 rounded-lg"><UserCheck size={14} className="text-emerald-400"/><span className="text-[10px] font-bold text-slate-300 truncate">{user.email}</span></div>
                            <button onClick={() => signOut(auth)} className="w-full flex items-center justify-center gap-2 py-3 bg-slate-800 hover:bg-rose-900/40 hover:text-rose-400 text-slate-400 text-xs font-bold rounded-xl transition-all"><LogOut size={14}/> Đăng xuất</button>
                        </div>
                    </aside>

                    {/* MAIN CONTENT */}
                    <main className={`flex-1 flex flex-col h-full sidebar-transition ${sidebarOpen ? 'ml-64' : 'ml-0'}`}>
                        <header className="p-6 bg-white/80 backdrop-blur-md border-b border-slate-200 flex justify-between items-center sticky top-0 z-[60]">
                            <div className="flex items-center gap-4">
                                <button onClick={() => setSidebarOpen(!sidebarOpen)} className="p-2 bg-slate-100 rounded-full hover:bg-indigo-50 hover:text-indigo-600 transition-all">
                                    {sidebarOpen ? <ChevronLeft size={20}/> : <Menu size={20}/>}
                                </button>
                                <h2 className="text-xl font-black uppercase tracking-tight text-slate-800">{activeTab}</h2>
                            </div>
                            <div className="flex items-center gap-3">
                                <div className="flex bg-slate-100 p-1 rounded-xl border border-slate-200">
                                    <input type="date" className="bg-transparent text-xs p-2 font-bold outline-none" value={globalFilters.dateStart} onChange={e => setGlobalFilters({...globalFilters, dateStart: e.target.value})}/>
                                    <span className="self-center text-slate-400 px-1">-</span>
                                    <input type="date" className="bg-transparent text-xs p-2 font-bold outline-none" value={globalFilters.dateEnd} onChange={e => setGlobalFilters({...globalFilters, dateEnd: e.target.value})}/>
                                </div>
                            </div>
                        </header>

                        <div className="flex-1 overflow-y-auto p-6 md:p-10 custom-scrollbar">
                            {/* DASHBOARD TAB */}
                            {activeTab === 'dashboard' && (
                                <div className="space-y-10 animate-in fade-in">
                                    <div className="grid grid-cols-1 md:grid-cols-4 gap-6">
                                        {[{ label: 'Tổng Task', val: filteredTasks.length, color: 'indigo', icon: TableIcon }, { label: 'Hoàn thành', val: filteredTasks.filter(t => t.overallStatus === 'Hoàn thành').length, color: 'emerald', icon: CheckCircle2 }, { label: 'Đang xử lý', val: filteredTasks.filter(t => t.overallStatus === 'Đang xử lý').length, color: 'amber', icon: Clock }, { label: 'Gấp', val: filteredTasks.filter(t => t.overallStatus === 'Gấp').length, color: 'rose', icon: AlertCircle }].map((kpi, i) => (
                                            <div key={i} className="bg-white p-7 rounded-3xl shadow-sm border border-slate-200"><div className={`w-12 h-12 flex items-center justify-center rounded-2xl mb-6 ${getColorClasses(kpi.color)}`}><kpi.icon size={24}/></div><h4 className="text-slate-400 text-[10px] font-black uppercase mb-1">{kpi.label}</h4><p className="text-4xl font-black text-slate-900">{kpi.val}</p></div>
                                        ))}
                                    </div>
                                    <div className="grid grid-cols-1 lg:grid-cols-2 gap-8">
                                        <div className="bg-white p-8 rounded-3xl border h-[400px] flex flex-col items-center">
                                            <h4 className="text-xs font-black uppercase mb-8 underline decoration-indigo-200 text-slate-400">Trạng thái tổng</h4>
                                            <ResponsiveContainer width="100%" height="90%"><BarChart data={chartOverall}><XAxis dataKey="name" style={{fontSize: '9px'}} /><Tooltip /><Bar dataKey="value" barSize={40} radius={[6, 6, 0, 0]}>{chartOverall.map((s, i) => <Cell key={i} fill={STATUS_COLOR_MAP[s.name]} />)}</Bar></BarChart></ResponsiveContainer>
                                        </div>
                                        <div className="bg-white p-8 rounded-3xl border h-[400px] flex flex-col items-center">
                                            <h4 className="text-xs font-black uppercase mb-8 underline decoration-indigo-200 text-slate-400">Tiến độ hạng mục</h4>
                                            <ResponsiveContainer width="100%" height="90%"><BarChart data={chartDataCategory}><XAxis dataKey="name" style={{fontSize: '9px'}} /><YAxis style={{fontSize: '9px'}}/><Tooltip/><Legend wrapperStyle={{fontSize: '10px'}}/><Bar dataKey="completed" name="Xong" stackId="a" fill="#10b981"/><Bar dataKey="pending" name="Chưa xong" stackId="a" fill="#f59e0b"/></BarChart></ResponsiveContainer>
                                        </div>
                                    </div>
                                    <div className="grid grid-cols-1 md:grid-cols-3 gap-8">
                                        {['brand', 'operation', 'media'].map(t => (
                                            <div key={t} className="bg-white p-6 rounded-3xl border h-[400px] flex flex-col">
                                                <h4 className="text-[10px] font-black uppercase text-slate-400 mb-4 tracking-widest text-center">Team {t.toUpperCase()}</h4>
                                                <ResponsiveContainer width="100%" height="200"><PieChart><Pie data={teamStats(t).filter(d => d.value > 0)} dataKey="value" nameKey="name" cx="50%" cy="50%" outerRadius={60} innerRadius={40} paddingAngle={5}>{teamStats(t).map((e, idx) => <Cell key={idx} fill={STATUS_COLOR_MAP[e.name]} />)}</Pie><Tooltip /></PieChart></ResponsiveContainer>
                                                <div className="flex-1 overflow-y-auto custom-scrollbar pt-4 space-y-2">
                                                    {teamUrgent(t).map(item => (<div key={item.id} className="p-3 bg-slate-50 rounded-xl border border-slate-100"><div className="text-[10px] font-bold text-slate-700 truncate">{item.taskName}</div><div className="flex justify-between items-center text-[9px] mt-1 text-rose-500 font-bold"><span>{item[`${t}Task`].deadline}</span><Clock size={10}/></div></div>))}
                                                </div>
                                            </div>
                                        ))}
                                    </div>
                                </div>
                            )}

                            {/* ADMIN TAB */}
                            {activeTab === 'admin' && role === 'admin' && (
                                <div className="space-y-10 animate-in fade-in">
                                    <div className="grid grid-cols-1 lg:grid-cols-2 gap-8">
                                        <div className="bg-white p-8 rounded-3xl border border-slate-200 shadow-sm">
                                            <h3 className="text-lg font-black mb-6 flex items-center gap-3"><UserCog size={24} className="text-indigo-600"/> Quản lý người dùng</h3>
                                            <div className="space-y-4">
                                                {usersList.map(u => (
                                                    <div key={u.id} className="flex items-center justify-between p-4 bg-slate-50 rounded-2xl border border-slate-200">
                                                        <div className="flex flex-col"><span className="text-sm font-black text-slate-700">{u.email}</span><span className="text-[9px] uppercase font-bold text-slate-400">Quyền: {u.role}</span></div>
                                                        {u.email !== user.email && (
                                                            <div className="flex gap-2">
                                                                <button onClick={() => handleRoleChange(u.id, u.role === 'admin' ? 'editor' : 'admin')} className="px-3 py-1.5 bg-white border border-slate-200 rounded-lg text-xs font-bold hover:bg-indigo-50 hover:text-indigo-600 transition-all">Đổi quyền</button>
                                                            </div>
                                                        )}
                                                    </div>
                                                ))}
                                            </div>
                                        </div>
                                        <div className="bg-white p-8 rounded-3xl border border-slate-200 shadow-sm">
                                            <h3 className="text-lg font-black mb-6 flex items-center gap-3"><History size={24} className="text-orange-600"/> Nhật ký Log (50)</h3>
                                            <div className="max-h-[500px] overflow-y-auto custom-scrollbar space-y-3">
                                                {logs.map(l => (
                                                    <div key={l.id} className="p-3 border-b text-[10px] font-mono hover:bg-slate-50">
                                                        <div className="flex justify-between mb-1"><span className="font-black text-indigo-600">{l.action}</span><span className="text-slate-400">{l.timestamp?.toDate().toLocaleString()}</span></div>
                                                        <div className="text-slate-500 truncate">{l.user}: {l.details}</div>
                                                    </div>
                                                ))}
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            )}

                            {/* LIST TAB */}
                            {activeTab === 'list' && (
                                <div className="bg-white rounded-3xl shadow-sm border border-slate-200 h-full flex flex-col overflow-hidden animate-in fade-in">
                                    <div className="p-4 border-b flex justify-between items-center bg-slate-50/50">
                                        <div className="flex gap-2">
                                            <button onClick={downloadTemplate} className="p-2 bg-white border rounded-xl hover:bg-indigo-50 hover:text-indigo-600 transition-all"><Download size={20}/></button>
                                            <label className="p-2 bg-indigo-600 text-white rounded-xl cursor-pointer hover:bg-indigo-700 transition-all"><Upload size={20}/><input type="file" className="hidden" onChange={handleFileUpload}/></label>
                                        </div>
                                    </div>
                                    <div className="flex-1 overflow-auto custom-scrollbar">
                                        <table className="table-fixed text-left border-collapse" style={{ width: 'max-content' }}>
                                            <thead>
                                                <tr className="bg-slate-50 text-[10px] font-black uppercase text-slate-400 tracking-widest divide-x">
                                                    <th className="px-4 py-4 sticky-col-0 text-center"><input type="checkbox" onChange={() => handleSelectAll(filteredTasks)} checked={filteredTasks.length > 0 && selectedIds.length === filteredTasks.length} /></th>
                                                    <th className="px-4 py-4 sticky-col-1 text-center" style={{ width: colWidths.actions }}>#</th>
                                                    <th className="px-6 py-4 sticky-col-2" style={{ width: 140 }}>Ngày/Tờ trình</th>
                                                    <th className="px-6 py-4 sticky-col-3" style={{ width: 320 }}>Công việc</th>
                                                    <th className="px-6 py-4 sticky-col-4" style={{ width: 160 }}>Trạng thái tổng</th>
                                                    <th className="px-6 py-4" style={{ width: 200 }}>Đơn vị</th>
                                                    <th className="px-6 py-4 bg-purple-50" style={{ width: 350 }}>Brand Team</th>
                                                    <th className="px-6 py-4 bg-orange-50" style={{ width: 350 }}>Operation Team</th>
                                                    <th className="px-6 py-4 bg-sky-50" style={{ width: 350 }}>Media Team</th>
                                                </tr>
                                                <tr className="bg-white border-b divide-x">
                                                    <th className="sticky-col-0"></th><th className="sticky-col-1"></th>
                                                    <th className="p-2 sticky-col-2"><input className="w-full p-1.5 text-[9px] border rounded" placeholder="Lọc ngày..." onChange={e => setColFilters({...colFilters, date: e.target.value})}/></th>
                                                    <th className="p-2 sticky-col-3"><input className="w-full p-1.5 text-[9px] border rounded" placeholder="Lọc việc..." onChange={e => setColFilters({...colFilters, task: e.target.value})}/></th>
                                                    <th className="p-2 sticky-col-4"><select className="w-full p-1.5 text-[9px] border rounded" onChange={e => setColFilters({...colFilters, overall: e.target.value})}><option value="">Tất cả</option>{OVERALL_STATUS.map(s => <option key={s} value={s}>{s}</option>)}</select></th>
                                                    <th className="p-2"><input className="w-full p-1.5 text-[9px] border rounded" placeholder="Lọc đơn vị..." onChange={e => setColFilters({...colFilters, unit: e.target.value})}/></th>
                                                    <th colSpan="3"></th>
                                                </tr>
                                            </thead>
                                            <tbody className="divide-y text-xs">
                                                {filteredTasks.map(t => (
                                                    <tr key={t.id} className="hover:bg-slate-50 transition-all divide-x">
                                                        <td className="px-4 py-4 sticky-col-0 text-center"><input type="checkbox" checked={selectedIds.includes(t.id)} onChange={(e) => handleSelectRow(e, t.id)} /></td>
                                                        <td className="px-4 py-4 sticky-col-1 text-center">{role === 'admin' && <button onClick={() => handleDeleteTask(t.id)} className="text-slate-300 hover:text-rose-600 transition-all"><Trash2 size={16}/></button>}</td>
                                                        <td className="px-6 py-4 sticky-col-2"><input type="date" className="bg-transparent font-bold w-full mb-1 outline-none" value={t.orderDate} onChange={e => handleUpdateTask(t.id, {orderDate: e.target.value})}/><select className="w-full text-[9px] font-black uppercase outline-none" value={t.paperStatus} onChange={e => handleUpdateTask(t.id, {paperStatus: e.target.value})}>{PAPER_STATUS.map(s => <option key={s} value={s}>{s}</option>)}</select></td>
                                                        <td className="px-6 py-4 sticky-col-3"><input className="w-full bg-transparent font-black mb-1 outline-none truncate" value={t.taskName} onChange={e => handleUpdateTask(t.id, {taskName: e.target.value})}/><MultiSelectModal inline options={CATEGORIES} selected={t.categories || []} onChange={v => handleUpdateTask(t.id, {categories: v})} /></td>
                                                        <td className="px-6 py-4 sticky-col-4 text-center"><select className="w-full font-black uppercase text-[10px] outline-none" style={{ color: STATUS_COLOR_MAP[t.overallStatus] }} value={t.overallStatus} onChange={e => handleUpdateTask(t.id, {overallStatus: e.target.value})}>{OVERALL_STATUS.map(s => <option key={s} value={s}>{s}</option>)}</select></td>
                                                        <td className="px-6 py-4"><select className="w-full outline-none font-bold text-slate-600 bg-transparent" value={t.unit} onChange={e => handleUpdateTask(t.id, {unit: e.target.value})}>{DEPARTMENTS.map(d => <option key={d} value={d}>{d}</option>)}</select></td>
                                                        {['brand', 'operation', 'media'].map(k => (
                                                            <td key={k} className={`px-6 py-4 ${k === 'brand' ? 'bg-purple-50/30' : k === 'operation' ? 'bg-orange-50/30' : 'bg-sky-50/30'}`}>
                                                                <input className="w-full bg-transparent font-bold mb-1 outline-none border-b border-transparent focus:border-slate-300" value={t[`${k}Task`]?.name || ''} onChange={e => handleUpdateTask(t.id, {[`${k}Task`]: {...t[`${k}Task`], name: e.target.value}})}/>
                                                                <div className="flex gap-2"><input type="date" className="bg-transparent text-[10px] outline-none" value={t[`${k}Task`]?.deadline || ''} onChange={e => handleUpdateTask(t.id, {[`${k}Task`]: {...t[`${k}Task`], deadline: e.target.value}})}/><select className="bg-transparent text-[10px] font-black outline-none" value={t[`${k}Task`]?.status || 'Chưa bắt đầu'} onChange={e => handleUpdateTask(t.id, {[`${k}Task`]: {...t[`${k}Task`], status: e.target.value}})}>{TASK_STATUS.map(s => <option key={s} value={s}>{s}</option>)}</select></div>
                                                            </td>
                                                        ))}
                                                    </tr>
                                                ))}
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            )}

                            {/* INPUT TAB */}
                            {activeTab === 'input' && (
                                <div className="max-w-4xl mx-auto animate-in slide-in-from-bottom pb-20">
                                    <form onSubmit={handleAddTask} className="bg-white p-12 rounded-[3rem] border shadow-xl space-y-12">
                                        <h3 className="text-xl font-black border-b pb-4">Tạo công việc mới</h3>
                                        <div className="grid grid-cols-1 md:grid-cols-2 gap-8">
                                            <div className="space-y-1"><label className="text-sm font-bold">Tên Task *</label><input required className="w-full p-4 bg-slate-50 rounded-2xl border outline-none" value={formData.taskName} onChange={e => setFormData({...formData, taskName: e.target.value})}/></div>
                                            <div className="space-y-1"><label className="text-sm font-bold">Đơn vị yêu cầu *</label><select required className="w-full p-4 bg-slate-50 rounded-2xl border outline-none" value={formData.unit} onChange={e => setFormData({...formData, unit: e.target.value})}><option value="">Chọn đơn vị</option>{DEPARTMENTS.map(d => <option key={d} value={d}>{d}</option>)}</select></div>
                                        </div>
                                        <div className="grid grid-cols-1 md:grid-cols-3 gap-8">
                                            <div className="space-y-1"><label className="text-sm font-bold">Ngày Order</label><input type="date" className="w-full p-4 bg-slate-50 rounded-2xl border outline-none" value={formData.orderDate} onChange={e => setFormData({...formData, orderDate: e.target.value})}/></div>
                                            <div className="space-y-1"><label className="text-sm font-bold">Trạng thái tổng</label><select className="w-full p-4 bg-indigo-50 text-indigo-700 font-bold rounded-2xl border outline-none" value={formData.overallStatus} onChange={e => setFormData({...formData, overallStatus: e.target.value})}>{OVERALL_STATUS.map(s => <option key={s} value={s}>{s}</option>)}</select></div>
                                            <div className="space-y-1"><label className="text-sm font-bold">Phân loại</label><MultiSelectModal options={CATEGORIES} selected={formData.categories} onChange={v => setFormData({...formData, categories: v})}/></div>
                                        </div>
                                        <button type="submit" className="w-full py-6 bg-indigo-600 text-white font-black rounded-[2rem] text-xl shadow-lg hover:bg-indigo-700 transition-all uppercase">Tạo công việc</button>
                                    </form>
                                </div>
                            )}
                        </div>
                    </main>
                </div>
            );
        }

        const root = createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
