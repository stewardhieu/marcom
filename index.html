<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>MarCom System v11 - No Login</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">

    <script type="importmap">
    {
      "imports": {
        "react": "https://esm.sh/react@18.2.0",
        "react-dom": "https://esm.sh/react-dom@18.2.0",
        "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
        "recharts": "https://esm.sh/recharts@2.12.7?external=react,react-dom",
        "lucide-react": "https://esm.sh/lucide-react@0.330.0",
        "firebase/app": "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js",
        "firebase/firestore": "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js"
      }
    }
    </script>

    <style>
        body { font-family: 'Inter', sans-serif; }
        .custom-scrollbar::-webkit-scrollbar { height: 6px; width: 6px; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #94a3b8; border-radius: 10px; }
        thead th { position: sticky; top: 0; z-index: 40; background-color: #f8fafc; box-shadow: 0 1px 0px #e2e8f0; }
        .sticky-col { position: sticky; z-index: 30; background-color: white; border-right: 1px solid #e2e8f0; }
        .col-0 { left: 0; width: 50px; }
        .col-1 { left: 50px; width: 140px; }
        .col-2 { left: 190px; width: 300px; border-right: 2px solid #94a3b8; }
    </style>
</head>
<body class="bg-[#F1F5F9] text-slate-800 h-screen overflow-hidden">
    <div id="root" class="h-full"></div>

    <script type="text/babel" data-type="module">
        import React, { useState, useEffect, useMemo } from 'react';
        import { createRoot } from 'react-dom/client';
        import { initializeApp } from 'firebase/app';
        import { getFirestore, collection, addDoc, onSnapshot, updateDoc, doc, serverTimestamp, deleteDoc } from 'firebase/firestore';
        import { LayoutDashboard, PlusCircle, Table as TableIcon, Trash2, CheckCircle2, Clock, AlertCircle, Menu, ChevronLeft, Briefcase } from 'lucide-react';
        import { BarChart, Bar, XAxis, YAxis, Tooltip, ResponsiveContainer, Cell } from 'recharts';

        const firebaseConfig = {
            apiKey: "AIzaSyDNdBlMZL42nkWc7W1OtgkWvkxKCwxKCjQ",
            authDomain: "marcom-dashboard-test.firebaseapp.com",
            projectId: "marcom-dashboard-test",
            storageBucket: "marcom-dashboard-test.firebasestorage.app",
            messagingSenderId: "840436404750",
            appId: "1:840436404750:web:783b44fa370f94b4dba25f"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        const DEPARTMENTS = ["Văn phòng trường", "P. Marketing và Truyền thông", "P. Đào tạo", "P. Hợp tác quốc tế", "K. Công nghệ thông tin", "K. Cơ khí - Cơ điện tử", "K. Điện - Điện tử", "Toàn trường"];
        const OVERALL_STATUS = ["Chờ duyệt", "Gấp", "Chưa bắt đầu", "Đang xử lý", "Hoàn thành"];
        const TASK_STATUS = ["Không có task", "Chưa bắt đầu", "Đang xử lý", "Hoàn thành"];

        function App() {
            const [activeTab, setActiveTab] = useState('dashboard');
            const [tasks, setTasks] = useState([]);
            const [sidebarOpen, setSidebarOpen] = useState(true);

            useEffect(() => {
                const unsub = onSnapshot(collection(db, 'marcom_v11_tasks'), (sn) => {
                    setTasks(sn.docs.map(d => ({ id: d.id, ...d.data() })).sort((a, b) => new Date(b.orderDate) - new Date(a.orderDate)));
                });
                return () => unsub();
            }, []);

            const handleUpdate = (id, data) => updateDoc(doc(db, 'marcom_v11_tasks', id), data);
            const handleDelete = (id) => confirm("Xóa task này?") && deleteDoc(doc(db, 'marcom_v11_tasks', id));

            const chartData = OVERALL_STATUS.map(s => ({ name: s, value: tasks.filter(t => t.overallStatus === s).length }));

            return (
                <div className="flex h-full overflow-hidden">
                    <aside className={`bg-[#0F172A] text-white w-64 transition-all ${sidebarOpen ? 'translate-x-0' : '-translate-x-full fixed'}`}>
                        <div className="p-8 border-b border-slate-800 flex items-center gap-3">
                            <Briefcase className="text-indigo-500" />
                            <span className="font-black text-xl">MarCom v11</span>
                        </div>
                        <nav className="p-4 space-y-2">
                            <button onClick={() => setActiveTab('dashboard')} className={`w-full flex items-center gap-4 px-5 py-4 rounded-xl ${activeTab === 'dashboard' ? 'bg-indigo-600' : 'text-slate-400 hover:bg-slate-800'}`}><LayoutDashboard size={18}/> Dashboard</button>
                            <button onClick={() => setActiveTab('list')} className={`w-full flex items-center gap-4 px-5 py-4 rounded-xl ${activeTab === 'list' ? 'bg-indigo-600' : 'text-slate-400 hover:bg-slate-800'}`}><TableIcon size={18}/> Danh sách</button>
                        </nav>
                    </aside>

                    <main className="flex-1 flex flex-col h-full bg-[#F1F5F9]">
                        <header className="p-6 bg-white border-b flex justify-between items-center">
                            <button onClick={() => setSidebarOpen(!sidebarOpen)} className="p-2 bg-slate-100 rounded-full"><Menu size={20}/></button>
                            <h2 className="text-xl font-black uppercase">{activeTab}</h2>
                            <div className="w-10"></div>
                        </header>

                        <div className="flex-1 overflow-auto p-6">
                            {activeTab === 'dashboard' ? (
                                <div className="space-y-6">
                                    <div className="grid grid-cols-1 md:grid-cols-4 gap-6">
                                        <div className="bg-white p-6 rounded-3xl border shadow-sm"><h4 className="text-slate-400 text-[10px] font-black uppercase">Tổng Task</h4><p className="text-3xl font-black">{tasks.length}</p></div>
                                        <div className="bg-white p-6 rounded-3xl border shadow-sm text-emerald-600"><h4 className="text-slate-400 text-[10px] font-black uppercase">Hoàn thành</h4><p className="text-3xl font-black">{tasks.filter(t => t.overallStatus === 'Hoàn thành').length}</p></div>
                                    </div>
                                    <div className="bg-white p-8 rounded-3xl border h-[400px]">
                                        <ResponsiveContainer width="100%" height="100%">
                                            <BarChart data={chartData}><XAxis dataKey="name"/><YAxis/><Tooltip/><Bar dataKey="value" fill="#6366f1" radius={[4, 4, 0, 0]}/></BarChart>
                                        </ResponsiveContainer>
                                    </div>
                                </div>
                            ) : (
                                <div className="bg-white rounded-3xl border overflow-hidden flex flex-col h-full">
                                    <div className="flex-1 overflow-auto custom-scrollbar">
                                        <table className="table-fixed text-left border-collapse" style={{ width: 'max-content' }}>
                                            <thead className="text-[10px] font-black uppercase text-slate-400">
                                                <tr className="bg-slate-50 divide-x">
                                                    <th className="px-4 py-4 sticky-col col-0 text-center">Xóa</th>
                                                    <th className="px-6 py-4 sticky-col col-1">Ngày</th>
                                                    <th className="px-6 py-4 sticky-col col-2">Nội dung</th>
                                                    <th className="px-6 py-4 w-[150px]">Trạng thái</th>
                                                    <th className="px-6 py-4 w-[200px]">Đơn vị</th>
                                                    <th className="px-6 py-4 bg-purple-50 w-[300px]">Brand</th>
                                                    <th className="px-6 py-4 bg-orange-50 w-[300px]">Operation</th>
                                                </tr>
                                            </thead>
                                            <tbody className="divide-y text-xs">
                                                {tasks.map(t => (
                                                    <tr key={t.id} className="divide-x hover:bg-slate-50">
                                                        <td className="px-4 py-4 sticky-col col-0 text-center"><button onClick={() => handleDelete(t.id)} className="text-slate-300 hover:text-rose-600"><Trash2 size={14}/></button></td>
                                                        <td className="px-6 py-4 sticky-col col-1 font-bold">{t.orderDate}</td>
                                                        <td className="px-6 py-4 sticky-col col-2 font-black">{t.taskName}</td>
                                                        <td className="px-6 py-4">
                                                            <select className="w-full font-bold outline-none bg-transparent" value={t.overallStatus} onChange={e => handleUpdate(t.id, {overallStatus: e.target.value})}>
                                                                {OVERALL_STATUS.map(s => <option key={s} value={s}>{s}</option>)}
                                                            </select>
                                                        </td>
                                                        <td className="px-6 py-4">{t.unit}</td>
                                                        <td className="px-6 py-4 bg-purple-50/20">
                                                            <input className="w-full bg-transparent font-bold outline-none" value={t.brandTask?.name || ''} onChange={e => handleUpdate(t.id, {brandTask: {...t.brandTask, name: e.target.value}})} />
                                                        </td>
                                                        <td className="px-6 py-4 bg-orange-50/20">
                                                            <input className="w-full bg-transparent font-bold outline-none" value={t.operationTask?.name || ''} onChange={e => handleUpdate(t.id, {operationTask: {...t.operationTask, name: e.target.value}})} />
                                                        </td>
                                                    </tr>
                                                ))}
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            )}
                        </div>
                    </main>
                </div>
            );
        }

        const root = createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
