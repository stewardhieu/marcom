import React, { useState, useEffect, useMemo, useRef } from 'react';
import { initializeApp } from 'firebase/app';
import { 
  getFirestore, 
  collection, 
  addDoc, 
  onSnapshot, 
  updateDoc, 
  doc, 
  query, 
  serverTimestamp,
  deleteDoc
} from 'firebase/firestore';
import { 
  getAuth, 
  signInAnonymously, 
  onAuthStateChanged, 
  signInWithCustomToken 
} from 'firebase/auth';
import { 
  LayoutDashboard, 
  PlusCircle, 
  Table as TableIcon,
  FileSpreadsheet, 
  Download, 
  Upload, 
  Trash2, 
  CheckCircle2, 
  Clock, 
  AlertCircle,
  Save,
  X,
  Link as LinkIcon,
  ChevronDown,
  Check,
  ExternalLink,
  Calendar,
  Tag,
  Users,
  Briefcase,
  PieChart as PieChartIcon,
  Database,
  Lock,
  Mail,
  LogOut,
  UserCheck,
  Wand2,
  BrainCircuit,
  Sparkles,
  RefreshCw
} from 'lucide-react';
import { BarChart, Bar, XAxis, YAxis, CartesianGrid, Tooltip, Legend, ResponsiveContainer, PieChart, Pie, Cell } from 'recharts';

// --- Firebase Configuration ---
const firebaseConfig = JSON.parse(__firebase_config);
const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);
const appId = typeof __app_id !== 'undefined' ? __app_id : 'marcom-hub-pro-v12';

// --- Gemini API Setup ---
const apiKey = ""; // Provided at runtime
const GEMINI_MODEL = "gemini-2.5-flash-preview-09-2025";

async function callGemini(payload) {
  try {
    const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${GEMINI_MODEL}:generateContent?key=${apiKey}`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(payload)
    });
    return await response.json();
  } catch (error) {
    console.error("AI Error:", error);
    throw error;
  }
}

// --- Constants ---
const DEPARTMENTS = [
  "BM Điều dưỡng", "BM Giáo dục chính trị- Pháp luật", "BM Giáo dục thể chất", "BM Kế toán", "BM Kinh tế học", 
  "BM Logistics và Quản lý chuỗi cung ứng", "BM Luật Kinh tế", "BM Ngôn ngữ Hàn Quốc", "BM Quản lý bệnh viện", 
  "BM Quản trị kinh doanh- Marketing", "BM Tài chính- Ngân hàng", "BM Thương mại điện tử", "BM Tiếng Anh", 
  "BM Tiếng Nhật", "BM Tiếng Pháp", "BM Tiếng Trung", "BM Toán", "BM Trí tuệ nhân tạo", "BM Việt Nam học", 
  "BM Y tế công cộng", "Công Đoàn", "CTSV Tham vấn tâm lý", "Đảng ủy", "Đoàn Thanh niên - Hội sinh viên", 
  "K. Âm nhạc ứng dụng", "K. Công nghệ thông tin", "K. Du lịch", "K. Khoa học sức khỏe", "K. Kinh tế- Quản lý", 
  "K. Truyền thông đa phương tiện", "K. Xã hội và Nhân văn", "P. Công nghệ thông tin", "P. Công tác chính trị sinh viên", 
  "P. Đào tạo", "P. Hợp tác quốc tế", "P. Marketing và Truyền thông", "P. Quản trị nguồn nhân lực", 
  "P. Sau đại học và Quản lý khoa học", "P. Tài chính- Kế toán", "P. Thanh tra- Pháp chế", 
  "P. Thí nghiệm trí tuệ nhân tạo Thăng Long", "P. Thông tin Tư liệu- Thư viện", "Tạp chí Khoa học Thăng Long", 
  "Tices - Viện Giáo dục và nhận thức Thăng Long", "Timas - Viện Toán học và khoa học ứng dụng Thăng Long", 
  "Toàn trường", "Trung tâm Đảm bảo chất lượng và Khảo thí", "Trung tâm E- Learning", 
  "TTC - Trung tâm Đào tạo ngắn hạn và chuyển giao công nghệ", "Văn phòng trường", "Operation - MarCom", 
  "Media - MarCom", "Brand - MarCom"
];

const CATEGORIES = ["Thiết kế", "Duyệt thiết kế", "Trực HT", "Đưa tin", "Chụp ảnh", "Hỗ trợ tổ chức sự kiện", "Khác"];
const PAPER_STATUS = ["Đã duyệt", "Chưa duyệt", "Hiệu trưởng duyệt", "N/A"];
const OVERALL_STATUS = ["Chưa bắt đầu", "Đang xử lý", "Hoàn thành", "Gác lại"];
const TASK_STATUS = ["Không", "Chưa bắt đầu", "Đang xử lý", "Hoàn thành", "Gác lại"];

const STATUS_COLOR_MAP = {
  "Chưa bắt đầu": "#94a3b8",
  "Đang xử lý": "#6366f1",
  "Hoàn thành": "#10b981",
  "Gác lại": "#f59e0b",
  "Không": "#cbd5e1"
};

const TEAM_COLORS = { brand: "#8b5cf6", operation: "#f97316", media: "#0ea5e9" };
const COLORS = ['#4f46e5', '#10b981', '#f59e0b', '#ef4444', '#8b5cf6', '#ec4899', '#06b6d4'];

const getColorClasses = (color) => {
  const map = {
    indigo: 'bg-indigo-50 text-indigo-600',
    emerald: 'bg-emerald-50 text-emerald-600',
    rose: 'bg-rose-50 text-rose-600',
    amber: 'bg-amber-50 text-amber-600',
    blue: 'bg-blue-50 text-blue-600'
  };
  return map[color] || 'bg-slate-50 text-slate-600';
};

// --- Sub-Components ---
const MultiSelect = ({ options, selected, onChange, inline = false }) => {
  const [isOpen, setIsOpen] = useState(false);
  const [coords, setCoords] = useState({ top: 0, left: 0, width: 0 });
  const containerRef = useRef(null);

  const handleOpen = (e) => {
    e.stopPropagation();
    if (containerRef.current) {
      const rect = containerRef.current.getBoundingClientRect();
      setCoords({ top: rect.bottom + window.scrollY, left: rect.left, width: rect.width });
    }
    setIsOpen(!isOpen);
  };

  useEffect(() => {
    const close = () => setIsOpen(false);
    if (isOpen) {
      document.addEventListener("mousedown", close);
      window.addEventListener("scroll", close);
    }
    return () => {
      document.removeEventListener("mousedown", close);
      window.removeEventListener("scroll", close);
    };
  }, [isOpen]);

  const toggleOption = (option) => {
    const newSelected = selected.includes(option) ? selected.filter(i => i !== option) : [...selected, option];
    onChange(newSelected);
  };

  return (
    <div className="relative" ref={containerRef}>
      <div 
        onClick={handleOpen}
        className={`w-full px-2 py-1.5 rounded border border-slate-200 bg-white flex items-center justify-between cursor-pointer hover:border-indigo-400 transition-all ${inline ? 'text-[9px] min-h-[28px]' : 'px-5 py-4 rounded-2xl bg-slate-50'}`}
      >
        <div className="flex flex-wrap gap-0.5">
          {selected.length === 0 ? <span className="text-slate-400 italic">-- Chọn --</span> : 
            selected.map(item => <span key={item} className="bg-indigo-50 text-indigo-700 text-[8px] px-1.5 py-0.5 rounded font-bold border border-indigo-100">{item}</span>)
          }
        </div>
        <ChevronDown size={12} className="text-slate-400 shrink-0 ml-1"/>
      </div>
      {isOpen && (
        <div 
          className="fixed z-[9999] bg-white border border-slate-100 rounded-xl shadow-2xl py-2 overflow-y-auto max-h-60 ring-1 ring-black ring-opacity-10"
          style={{ top: coords.top + 5, left: coords.left, width: Math.max(coords.width, 220) }}
        >
          {options.map(option => (
            <div key={option} onClick={(e) => { e.stopPropagation(); toggleOption(option); }} className="flex items-center gap-3 px-4 py-2 hover:bg-slate-50 cursor-pointer">
              <div className={`w-4 h-4 rounded border flex items-center justify-center ${selected.includes(option) ? 'bg-indigo-600 border-indigo-600' : 'border-slate-200'}`}>
                {selected.includes(option) && <Check size={10} className="text-white font-bold"/>}
              </div>
              <span className={`text-xs ${selected.includes(option) ? 'text-indigo-600 font-bold' : 'text-slate-600'}`}>{option}</span>
            </div>
          ))}
        </div>
      )}
    </div>
  );
};

const DeleteModal = ({ isOpen, onConfirm, onCancel, taskName }) => {
  if (!isOpen) return null;
  return (
    <div className="fixed inset-0 z-[10000] flex items-center justify-center p-4 bg-slate-900/60 backdrop-blur-sm animate-in fade-in duration-200">
      <div className="bg-white rounded-[2.5rem] shadow-2xl max-w-md w-full p-10 text-center space-y-6">
        <div className="mx-auto w-16 h-16 bg-rose-50 text-rose-600 rounded-full flex items-center justify-center mb-2"><AlertCircle size={32}/></div>
        <h3 className="text-xl font-black text-slate-900 uppercase tracking-tighter">Xác nhận xóa?</h3>
        <p className="text-slate-500 text-sm italic leading-relaxed">Ticket <br/><span className="font-bold text-slate-800">"{taskName}"</span> <br/>sẽ bị xóa vĩnh viễn khỏi hệ thống.</p>
        <div className="flex gap-4 pt-4">
          <button onClick={onCancel} className="flex-1 py-3 bg-slate-100 text-slate-600 rounded-2xl font-bold hover:bg-slate-200 transition-colors">Hủy</button>
          <button onClick={onConfirm} className="flex-1 py-3 bg-rose-600 text-white rounded-2xl font-bold shadow-lg shadow-rose-100 hover:bg-rose-700 transition-colors">Xóa</button>
        </div>
      </div>
    </div>
  );
};

// --- Main App Component ---
export default function App() {
  const [user, setUser] = useState(null);
  const [activeTab, setActiveTab] = useState('dashboard');
  const [tasks, setTasks] = useState([]);
  const [loading, setLoading] = useState(true);
  const [isXlsxLoaded, setIsXlsxLoaded] = useState(false);
  const [deleteModal, setDeleteModal] = useState({ open: false, taskId: null, taskName: '' });
  const [isAiLoading, setIsAiLoading] = useState(false);
  const [aiAnalysis, setAiAnalysis] = useState("");

  const [colWidths, setColWidths] = useState({
    actions: 80, admin: 140, task: 280, overall: 160, unit: 180, info: 140, 
    brand: 450, operation: 450, media: 450
  });
  const [colFilters, setColFilters] = useState({ date: '', ticket: '', task: '', overall: '', unit: '' });
  const [globalFilters, setGlobalFilters] = useState({ dateStart: '', dateEnd: '', unit: '', category: '' });

  const emptyFormData = {
    orderDate: new Date().toISOString().split('T')[0],
    paperStatus: 'Chưa duyệt',
    taskName: '',
    overallStatus: 'Chưa bắt đầu',
    unit: '',
    categories: [],
    location: '',
    time: '',
    brandTask: { name: '', deadline: '', status: 'Chưa bắt đầu', link: '' },
    operationTask: { name: '', deadline: '', status: 'Chưa bắt đầu', link: '' },
    mediaTask: { name: '', deadline: '', status: 'Chưa bắt đầu', link: '' }
  };
  const [formData, setFormData] = useState(emptyFormData);

  // Sync Libraries & Auth
  useEffect(() => {
    const script = document.createElement('script');
    script.src = "https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js";
    script.async = true;
    script.onload = () => setIsXlsxLoaded(true);
    document.body.appendChild(script);
    
    const initAuth = async () => {
      if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) await signInWithCustomToken(auth, __initial_auth_token);
      else await signInAnonymously(auth);
    };
    initAuth();
    return onAuthStateChanged(auth, setUser);
  }, []);

  useEffect(() => {
    if (!user) return;
    const q = collection(db, 'artifacts', appId, 'public', 'data', 'marcom_v11_tasks');
    const unsubscribe = onSnapshot(q, (sn) => {
      const data = sn.docs.map(d => ({ id: d.id, ...d.data() }));
      setTasks(data.sort((a, b) => new Date(b.orderDate) - new Date(a.orderDate)));
      setLoading(false);
    });
    return () => unsubscribe();
  }, [user]);

  // Handlers
  const handleAddTask = async (e) => {
    e.preventDefault();
    try {
      await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'marcom_v11_tasks'), { ...formData, createdAt: serverTimestamp() });
      setFormData(emptyFormData);
      setActiveTab('list');
    } catch (e) { console.error(e); }
  };

  const handleUpdateTask = async (id, updatedData) => {
    try {
      const d = doc(db, 'artifacts', appId, 'public', 'data', 'marcom_v11_tasks', id);
      await updateDoc(d, updatedData);
    } catch (e) { console.error(e); }
  };

  const confirmDelete = async () => {
    if (!deleteModal.taskId) return;
    try {
      await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'marcom_v11_tasks', deleteModal.taskId));
      setDeleteModal({ open: false, taskId: null, taskName: '' });
    } catch (e) { console.error(e); }
  };

  const createMockData = async () => {
    const mock = [
      { ...emptyFormData, taskName: "Thiết kế Profile Khoa Cơ khí", unit: "K. Công nghệ thông tin", overallStatus: "Đang xử lý", orderDate: "2026-01-05", categories: ["Thiết kế"], brandTask: { deadline: "2026-01-10", status: "Đang xử lý", detail: "Xong layout" } },
      { ...emptyFormData, taskName: "Hội thảo Điện tử 2026", unit: "K. Điện - Điện tử", overallStatus: "Hoàn thành", paperStatus: "Hiệu trưởng duyệt", orderDate: "2026-01-01", categories: ["Hỗ trợ tổ chức sự kiện"], operationTask: { deadline: "2026-01-02", status: "Hoàn thành" } }
    ];
    for (const t of mock) await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'marcom_v11_tasks'), { ...t, createdAt: serverTimestamp() });
    alert("Đã khởi tạo dữ liệu mẫu!");
  };

  const handleResize = (key, startX, startWidth) => {
    const move = (e) => setColWidths(prev => ({ ...prev, [key]: Math.max(60, startWidth + (e.clientX - startX)) }));
    const up = () => { document.removeEventListener('mousemove', move); document.removeEventListener('mouseup', up); };
    document.addEventListener('mousemove', move);
    document.addEventListener('mouseup', up);
  };

  const downloadTemplate = () => {
    if (!isXlsxLoaded || !window.XLSX) return;
    const XLSX = window.XLSX;
    const templateData = [{ "Ngày Order": "2026-01-07", "Tờ trình": "Chưa duyệt", "Tên Task Chung": "Tên sự kiện...", "Hoàn thành tổng": "Chưa bắt đầu", "Đơn vị": "Văn phòng trường", "Phân loại": "Thiết kế" }];
    const ws = XLSX.utils.json_to_sheet(templateData);
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, "Tasks");
    XLSX.writeFile(wb, "MarCom_Hub_Template.xlsx");
  };

  const handleFileUpload = (e) => {
    if (!isXlsxLoaded || !window.XLSX) return;
    const XLSX = window.XLSX;
    const file = e.target.files[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = async (evt) => {
      const bstr = evt.target.result;
      const wb = XLSX.read(bstr, { type: 'binary' });
      const data = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]]);
      for (const row of data) {
        const payload = {
          ...emptyFormData,
          orderDate: row["Ngày Order"] || new Date().toISOString().split('T')[0],
          paperStatus: row["Tờ trình"] || "Chưa duyệt",
          taskName: row["Tên Task Chung"] || "Không tên",
          overallStatus: row["Hoàn thành tổng"] || "Chưa bắt đầu",
          unit: row["Đơn vị"] || "Toàn trường",
          categories: row["Phân loại"] ? row["Phân loại"].split(',').map(s => s.trim()) : [],
        };
        await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'marcom_v11_tasks'), payload);
      }
      alert("Đã nhập dữ liệu thành công!");
      setActiveTab('list');
    };
    reader.readAsBinaryString(file);
    e.target.value = null;
  };

  // --- AI Logic ---
  const handleAiOptimize = async () => {
    if (!formData.taskName) return;
    setIsAiLoading(true);
    try {
      const systemPrompt = `You are a MarCom expert. Suggest a professional Vietnamese title and categories: ${CATEGORIES.join(', ')}. JSON format: { "title": "...", "cats": ["..."] }`;
      const res = await callGemini({ contents: [{ parts: [{ text: `Task: ${formData.taskName}` }] }], systemInstruction: { parts: [{ text: systemPrompt }] }, generationConfig: { responseMimeType: "application/json" } });
      const data = JSON.parse(res.candidates[0].content.parts[0].text);
      setFormData(p => ({ ...p, taskName: data.title, categories: data.cats }));
    } catch (e) { console.error(e); } finally { setIsAiLoading(false); }
  };

  const handleAiAnalysis = async () => {
    if (tasks.length === 0) return;
    setIsAiLoading(true);
    try {
      const ctx = tasks.map(t => `${t.taskName} (${t.overallStatus})`).join(', ');
      const res = await callGemini({ contents: [{ parts: [{ text: `Danh sách: ${ctx.substring(0, 1500)}` }] }], systemInstruction: { parts: [{ text: "Hãy đưa ra nhận xét ngắn gọn (3 câu) bằng tiếng Việt về tình hình công việc MarCom hiện tại." }] } });
      setAiAnalysis(res.candidates[0].content.parts[0].text);
    } catch (e) { console.error(e); } finally { setIsAiLoading(false); }
  };

  // --- useMemo Calculations (Top Level) ---
  const filteredTasks = useMemo(() => {
    return tasks.filter(t => {
      const dateG = (!globalFilters.dateStart || t.orderDate >= globalFilters.dateStart) && (!globalFilters.dateEnd || t.orderDate <= globalFilters.dateEnd);
      const unitG = !globalFilters.unit || t.unit === globalFilters.unit;
      const dateC = !colFilters.date || t.orderDate.includes(colFilters.date);
      const nameC = !colFilters.task || t.taskName.toLowerCase().includes(colFilters.task.toLowerCase());
      const overallC = !colFilters.overall || t.overallStatus === colFilters.overall;
      return dateG && unitG && dateC && nameC && overallC;
    });
  }, [tasks, globalFilters, colFilters]);

  const chartDataOverall = useMemo(() => {
    const counts = {}; OVERALL_STATUS.forEach(s => counts[s] = 0);
    filteredTasks.forEach(t => { const s = t.overallStatus || 'Chưa bắt đầu'; if (counts[s] !== undefined) counts[s]++; });
    return Object.entries(counts).map(([name, value]) => ({ name, value }));
  }, [filteredTasks]);

  const chartDataUnit = useMemo(() => {
    const counts = {}; filteredTasks.forEach(t => counts[t.unit] = (counts[t.unit] || 0) + 1);
    return Object.entries(counts).map(([name, value]) => ({ name, value })).sort((a,b) => b.value - a.value).slice(0, 8);
  }, [filteredTasks]);

  const teamVolumeData = useMemo(() => {
    return [
      { name: 'Brand', value: filteredTasks.filter(t => t.brandTask?.status !== 'Không').length },
      { name: 'Operation', value: filteredTasks.filter(t => t.operationTask?.status !== 'Không').length },
      { name: 'Media', value: filteredTasks.filter(t => t.mediaTask?.status !== 'Không').length }
    ];
  }, [filteredTasks]);

  const teamStats = (teamKey) => {
    const counts = {}; TASK_STATUS.forEach(s => counts[s] = 0);
    filteredTasks.forEach(t => { const s = t[`${teamKey}Task`]?.status || 'Chưa bắt đầu'; if (counts[s] !== undefined) counts[s]++; });
    return Object.entries(counts).map(([name, value]) => ({ name, value }));
  };

  const teamUrgent = (teamKey) => {
    const today = new Date(); const limit = new Date(); limit.setDate(today.getDate() + 3);
    return filteredTasks.filter(t => {
      const dStr = t[`${teamKey}Task`]?.deadline; if (!dStr) return false;
      return new Date(dStr) >= today && new Date(dStr) <= limit && t[`${teamKey}Task`]?.status !== 'Hoàn thành' && t[`${teamKey}Task`]?.status !== 'Không';
    });
  };

  return (
    <div className="min-h-screen bg-[#F8FAFC] flex font-sans text-slate-800">
      <style>{`
        .custom-scrollbar::-webkit-scrollbar { height: 10px; width: 8px; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
        .sticky-col-0 { position: sticky; left: 0; z-index: 45; background: white; border-right: 1px solid #e2e8f0; }
        .sticky-col-1 { position: sticky; left: ${colWidths.actions}px; z-index: 45; background: white; border-right: 1px solid #e2e8f0; }
        .sticky-col-2 { position: sticky; left: ${colWidths.actions + colWidths.admin}px; z-index: 45; background: white; border-right: 1px solid #e2e8f0; }
        .sticky-col-3 { position: sticky; left: ${colWidths.actions + colWidths.admin + colWidths.task}px; z-index: 45; background: white; border-right: 3px solid #cbd5e1; }
        .resizer { position: absolute; right: 0; top: 0; bottom: 0; width: 6px; cursor: col-resize; z-index: 80; }
        .resizer:hover { background: #6366f1; opacity: 0.3; }
        .tab-content { display: none; height: 100%; width: 100%; }
        .tab-content.active { display: flex; flex-direction: column; }
      `}</style>

      {isAiLoading && (
        <div className="fixed inset-0 z-[20000] bg-white/60 backdrop-blur-sm flex items-center justify-center flex-col gap-4">
           <div className="animate-spin text-indigo-600"><RefreshCw size={48}/></div>
           <p className="font-black text-indigo-950 uppercase tracking-widest text-sm animate-pulse">✨ Trí tuệ nhân tạo đang xử lý...</p>
        </div>
      )}

      <DeleteModal 
        isOpen={deleteModal.open} taskName={deleteModal.taskName} 
        onCancel={() => setDeleteModal({ open: false, taskId: null, taskName: '' })}
        onConfirm={confirmDelete}
      />

      {/* Sidebar */}
      <aside className="w-64 bg-[#0F172A] fixed h-full flex flex-col z-[100] text-white shadow-2xl">
        <div className="p-8 border-b border-slate-800 flex items-center gap-3">
          <div className="w-9 h-9 bg-indigo-500 rounded-lg flex items-center justify-center shadow-lg"><Briefcase size={20}/></div>
          <h1 className="text-lg font-black tracking-tighter leading-none">MarCom<br/><span className="text-[10px] text-indigo-400 uppercase tracking-widest font-bold">Portal v12</span></h1>
        </div>
        <nav className="p-4 flex-1 space-y-1">
          {[
            { id: 'dashboard', label: 'Dashboard', icon: LayoutDashboard },
            { id: 'input', label: 'Tạo công việc', icon: PlusCircle },
            { id: 'list', label: 'Danh sách', icon: TableIcon }
          ].map(tab => (
            <button key={tab.id} onClick={() => setActiveTab(tab.id)} className={`w-full flex items-center gap-4 px-5 py-4 rounded-xl transition-all ${activeTab === tab.id ? 'bg-indigo-600 text-white shadow-lg font-bold' : 'text-slate-400 hover:bg-slate-800 hover:text-white'}`}>
              <tab.icon size={18}/> {tab.label}
            </button>
          ))}
        </nav>
        <div className="p-4 border-t border-slate-800">
           <button onClick={createMockData} className="w-full py-2 bg-slate-800 hover:bg-slate-700 text-slate-400 text-[9px] font-bold rounded-lg flex items-center justify-center gap-2 transition-all"><Database size={12}/> Khởi tạo dữ liệu mẫu</button>
        </div>
      </aside>

      {/* Main Content */}
      <main className="ml-64 flex-1 p-8 min-w-0 overflow-y-auto flex flex-col">
        
        {/* DASHBOARD */}
        <div className={`tab-content ${activeTab === 'dashboard' ? 'active' : ''}`}>
           <div className="space-y-10 animate-in fade-in duration-500 pb-20">
              <header className="flex justify-between items-end border-b border-slate-200 pb-6">
                <div>
                  <h2 className="text-4xl font-black text-slate-900 tracking-tighter uppercase">Thống kê nghiệp vụ</h2>
                  <p className="text-slate-500 font-medium text-sm">Hệ thống giám sát hiệu suất thời gian thực.</p>
                </div>
                <button onClick={handleAiAnalysis} className="flex items-center gap-2 px-5 py-2.5 bg-indigo-600 text-white rounded-2xl text-xs font-bold shadow-lg shadow-indigo-100 hover:bg-indigo-700 transition-all"><Sparkles size={16}/> ✨ AI Phân tích</button>
              </header>

              {aiAnalysis && <div className="bg-indigo-50 border border-indigo-100 p-6 rounded-[2rem] flex gap-4 animate-in slide-in-from-top duration-500"><div className="p-3 bg-white text-indigo-600 rounded-2xl h-fit"><BrainCircuit size={24}/></div><div className="flex-1 text-sm font-medium text-indigo-900 italic leading-relaxed">{aiAnalysis}</div><button onClick={() => setAiAnalysis("")} className="text-indigo-300 hover:text-indigo-600"><X size={18}/></button></div>}

              <div className="bg-white p-6 rounded-[2rem] border border-slate-200 shadow-sm grid grid-cols-4 gap-6">
                 <div className="space-y-1">
                    <label className="text-[10px] font-black uppercase text-slate-400">Thời gian</label>
                    <div className="flex gap-2"><input type="date" className="w-1/2 p-2 border rounded-xl text-xs" value={globalFilters.dateStart} onChange={e => setGlobalFilters({...globalFilters, dateStart: e.target.value})} /><input type="date" className="w-1/2 p-2 border rounded-xl text-xs" value={globalFilters.dateEnd} onChange={e => setGlobalFilters({...globalFilters, dateEnd: e.target.value})} /></div>
                 </div>
                 <div className="space-y-1">
                    <label className="text-[10px] font-black uppercase text-slate-400">Đơn vị yêu cầu</label>
                    <select className="w-full p-2 border rounded-xl text-xs font-bold" value={globalFilters.unit} onChange={e => setGlobalFilters({...globalFilters, unit: e.target.value})}><option value="">Tất cả đơn vị</option>{DEPARTMENTS.map(d => <option key={d} value={d}>{d}</option>)}</select>
                 </div>
                 <div className="flex items-end"><button onClick={() => setGlobalFilters({dateStart:'', dateEnd:'', unit:'', category:''})} className="w-full py-2.5 bg-slate-100 text-slate-500 rounded-xl text-[10px] font-black hover:bg-slate-200 uppercase">Xóa bộ lọc</button></div>
              </div>

              <div className="grid grid-cols-4 gap-6">
                 {[
                   { label: 'Tổng Ticket', val: filteredTasks.length, color: 'indigo', Icon: TableIcon }, 
                   { label: 'Hoàn thành', val: filteredTasks.filter(t => t.overallStatus === 'Hoàn thành').length, color: 'emerald', Icon: CheckCircle2 }, 
                   { label: 'Đang xử lý', val: filteredTasks.filter(t => t.overallStatus === 'Đang xử lý').length, color: 'amber', Icon: Clock }, 
                   { label: 'Chưa duyệt', val: filteredTasks.filter(t => t.paperStatus === 'Chưa duyệt').length, color: 'rose', Icon: AlertCircle }
                 ].map((kpi, i) => (
                   <div key={i} className="bg-white p-7 rounded-[2.5rem] border border-slate-200 shadow-sm transition-all hover:shadow-lg">
                     <div className={`w-12 h-12 flex items-center justify-center rounded-2xl mb-6 ${getColorClasses(kpi.color)}`}><kpi.Icon size={24}/></div>
                     <h4 className="text-slate-400 text-[11px] font-black uppercase mb-1 tracking-widest">{kpi.label}</h4>
                     <p className="text-4xl font-black text-slate-900">{kpi.val}</p>
                   </div>
                 ))}
              </div>

              <div className="grid grid-cols-1 lg:grid-cols-3 gap-8">
                 <div className="bg-white p-8 rounded-[2.5rem] border border-slate-200 h-[400px]">
                    <h4 className="text-xs font-black text-slate-400 uppercase mb-6 text-center tracking-widest underline decoration-indigo-200">Trạng thái hoàn thành tổng</h4>
                    <ResponsiveContainer width="100%" height="90%"><BarChart data={chartDataOverall}>
                      <XAxis dataKey="name" style={{fontSize: '9px', fontWeight: 700}} /><Tooltip />
                      <Bar dataKey="value" radius={[6, 6, 0, 0]} barSize={40}>{chartDataOverall.map((s, i) => <Cell key={i} fill={STATUS_COLOR_MAP[s.name]} />)}</Bar>
                    </BarChart></ResponsiveContainer>
                 </div>
                 <div className="bg-white p-8 rounded-[2.5rem] border border-slate-200 h-[400px] lg:col-span-2 flex flex-col items-center">
                    <h4 className="text-xs font-black text-slate-400 uppercase mb-6 tracking-widest underline decoration-indigo-200">Phân bổ khối lượng Team</h4>
                    <ResponsiveContainer width="100%" height="80%"><BarChart data={teamVolumeData} layout="vertical">
                      <XAxis type="number" hide /><YAxis dataKey="name" type="category" width={100} style={{fontSize: '11px', fontWeight: 800}} /><Tooltip /><Bar dataKey="value" barSize={35} radius={[0, 8, 8, 0]}>{teamVolumeData.map((e, i) => <Cell key={i} fill={TEAM_COLORS[e.name.toLowerCase()]} />)}</Bar>
                    </BarChart></ResponsiveContainer>
                 </div>
              </div>

              <div className="grid grid-cols-3 gap-8 border-t pt-10">
                 {['brand', 'operation', 'media'].map(t => (
                   <div key={t} className={`p-8 bg-white rounded-[2.5rem] border border-slate-200 h-[450px] flex flex-col ${teamUrgent(t).length > 0 ? 'border-rose-200 shadow-2xl shadow-rose-50' : ''}`}>
                      <h4 className="text-[10px] font-black uppercase text-slate-400 tracking-widest mb-6 flex justify-between">
                         <span>Team {t.toUpperCase()} Sát Deadline</span>
                         <span className="bg-slate-100 px-2 py-0.5 rounded text-indigo-600 font-bold">{teamUrgent(t).length}</span>
                      </h4>
                      <div className="flex-1 overflow-y-auto custom-scrollbar space-y-3 pr-2">
                        {teamUrgent(t).length === 0 ? <div className="h-full flex items-center justify-center text-slate-300 italic text-xs">Hoạt động ổn định</div> : 
                          teamUrgent(t).map(item => (
                            <div key={item.id} className="p-4 bg-slate-50 rounded-2xl border border-slate-100">
                               <div className="text-[11px] font-black text-slate-800 leading-tight mb-1 truncate">{item.taskName}</div>
                               <div className="flex justify-between items-center text-[9px] font-bold text-rose-500 mt-1"><span className="text-slate-400 truncate max-w-[80px]">{item.unit}</span><span className="flex items-center gap-1 bg-rose-50 px-2 py-0.5 rounded-lg font-black tracking-tighter"><Clock size={10}/> {item[`${t}Task`].deadline}</span></div>
                            </div>
                          ))
                        }
                      </div>
                      <div className="mt-4 pt-4 border-t border-slate-100 flex flex-wrap gap-2">
                         {teamStats(t).map((s, idx) => (
                           <div key={idx} className="flex items-center gap-1.5 text-[8px] font-black uppercase text-slate-400">
                             <div className="w-1.5 h-1.5 rounded-full" style={{ background: STATUS_COLOR_MAP[s.name] }}></div>
                             {s.name.charAt(0)}: {s.value}
                           </div>
                         ))}
                      </div>
                   </div>
                 ))}
              </div>
           </div>
        </div>

        {/* --- INPUT TAB --- */}
        <div className={`tab-content ${activeTab === 'input' ? 'active' : ''}`}>
           <div className="max-w-4xl mx-auto animate-in slide-in-from-bottom duration-500 pb-20">
              <header className="mb-10 flex justify-between items-center"><h2 className="text-3xl font-black text-slate-900 tracking-tighter uppercase">Khởi tạo Ticket</h2><button onClick={handleAiOptimize} className="flex items-center gap-2 px-4 py-2 bg-indigo-50 text-indigo-600 rounded-xl text-[10px] font-black uppercase hover:bg-indigo-100 transition-all"><Wand2 size={14}/> ✨ Tối ưu bằng AI</button></header>
              <form onSubmit={handleAddTask} className="bg-white p-12 rounded-[3rem] border border-slate-200 shadow-xl space-y-12">
                 <div className="space-y-8">
                    <h3 className="text-[11px] font-black text-indigo-600 uppercase tracking-widest border-b pb-2">I. Thông tin chung</h3>
                    <div className="grid grid-cols-2 gap-8">
                       <div className="space-y-1"><label className="text-sm font-bold">Tên Task (Chung) *</label><input required className="w-full px-6 py-4 rounded-2xl border border-slate-200 bg-slate-50 text-sm focus:ring-4 focus:ring-indigo-500/10 outline-none transition-all" value={formData.taskName} onChange={e => setFormData({...formData, taskName: e.target.value})} placeholder="Tên chiến dịch..." /></div>
                       <div className="space-y-1"><label className="text-sm font-bold">Đơn vị yêu cầu *</label><select required className="w-full px-6 py-4 rounded-2xl border border-slate-200 bg-slate-50 text-sm outline-none font-bold" value={formData.unit} onChange={e => setFormData({...formData, unit: e.target.value})}><option value="">-- Chọn đơn vị --</option>{DEPARTMENTS.map(d => <option key={d} value={d}>{d}</option>)}</select></div>
                    </div>
                    <div className="grid grid-cols-3 gap-8">
                       <div className="space-y-1"><label className="text-sm font-bold">Ngày Order</label><input type="date" className="w-full px-5 py-4 rounded-2xl border-slate-200 bg-slate-50 text-sm outline-none" value={formData.orderDate} onChange={e => setFormData({...formData, orderDate: e.target.value})} /></div>
                       <div className="space-y-1"><label className="text-sm font-bold text-indigo-600">Hoàn thành tổng *</label><select className="w-full px-5 py-4 rounded-2xl border-indigo-200 bg-indigo-50 text-sm font-black text-indigo-700" value={formData.overallStatus} onChange={e => setFormData({...formData, overallStatus: e.target.value})}>{OVERALL_STATUS.map(s => <option key={s} value={s}>{s}</option>)}</select></div>
                       <div className="space-y-1"><label className="text-sm font-bold">Phân loại</label><MultiSelect options={CATEGORIES} selected={formData.categories} onChange={v => setFormData({...formData, categories: v})} /></div>
                    </div>
                 </div>
                 <div className="space-y-8 pt-10 border-t border-slate-100">
                    <h3 className="text-[11px] font-black text-indigo-600 uppercase tracking-widest border-b pb-2">II. Phân công đội ngũ</h3>
                    <div className="grid grid-cols-3 gap-6">
                       {['brand', 'operation', 'media'].map(t => (
                         <div key={t} className="p-6 bg-slate-50 rounded-3xl border border-slate-100 space-y-4">
                            <span className="text-[10px] font-black uppercase text-slate-400">Team {t.toUpperCase()}</span>
                            <input className="w-full p-3 text-[11px] border border-slate-200 rounded-xl font-bold bg-white" placeholder="Tên task cụ thể..." value={formData[`${t}Task`].name} onChange={e => setFormData({...formData, [`${t}Task`]: {...formData[`${t}Task`], name: e.target.value}})} />
                            <select className="w-full p-3 text-[11px] border rounded-xl font-bold bg-white outline-none" value={formData[`${t}Task`].status} onChange={e => setFormData({...formData, [`${t}Task`]: {...formData[`${t}Task`], status: e.target.value}})}>{TASK_STATUS.map(s => <option key={s} value={s}>{s}</option>)}</select>
                            <input type="date" className="w-full p-3 text-[11px] border rounded-xl bg-white outline-none" value={formData[`${t}Task`].deadline} onChange={e => setFormData({...formData, [`${t}Task`]: {...formData[`${t}Task`], deadline: e.target.value}})} />
                         </div>
                       ))}
                    </div>
                 </div>
                 <button type="submit" className="w-full bg-indigo-600 text-white font-black py-7 rounded-[2.5rem] shadow-2xl hover:bg-indigo-700 transition-all text-xl uppercase tracking-tighter">Phát hành Ticket</button>
              </form>
           </div>
        </div>

        {/* --- LIST TAB --- */}
        <div className={`tab-content h-full flex flex-col ${activeTab === 'list' ? 'active' : ''}`}>
           <div className="flex flex-col h-full overflow-hidden">
              <header className="mb-6 flex justify-between items-center"><h2 className="text-3xl font-black text-slate-900 tracking-tighter uppercase tracking-widest">Danh sách công việc</h2><div className="flex gap-2"><button onClick={downloadTemplate} title="Tải Excel mẫu" className="p-3 bg-white border rounded-xl text-slate-400 hover:text-indigo-600 shadow-sm transition-all"><Download size={20}/></button><label className="p-3 bg-indigo-600 text-white rounded-xl shadow-lg cursor-pointer hover:bg-indigo-700 transition-all"><Upload size={20}/><input type="file" className="hidden" onChange={handleFileUpload}/></label></div></header>
              <div className="bg-white rounded-[2.5rem] border shadow-sm flex-1 overflow-hidden relative flex flex-col">
                 <div className="overflow-auto custom-scrollbar flex-1 pb-80">
                    <table className="table-fixed text-left border-collapse divide-x divide-slate-100" style={{ width: 'max-content' }}>
                       <thead className="sticky top-0 z-[70]">
                          <tr className="bg-slate-50 border-b border-slate-200 text-[10px] font-black uppercase text-slate-400 tracking-widest divide-x divide-slate-200">
                             <th className="px-4 py-5 sticky-col-0" style={{ width: colWidths.actions }}>Tác vụ <div className="resizer" onMouseDown={(e) => handleResize('actions', e.clientX, colWidths.actions)} /></th>
                             <th className="px-6 py-5 sticky-col-1" style={{ width: colWidths.admin }}>Hành chính <div className="resizer" onMouseDown={(e) => handleResize('admin', e.clientX, colWidths.admin)} /></th>
                             <th className="px-6 py-5 sticky-col-2" style={{ width: colWidths.task }}>Tên Task <div className="resizer" onMouseDown={(e) => handleResize('task', e.clientX, colWidths.task)} /></th>
                             <th className="px-6 py-5 sticky-col-3 bg-indigo-50/50" style={{ width: colWidths.overall }}>Hoàn thành tổng <div className="resizer" onMouseDown={(e) => handleResize('overall', e.clientX, colWidths.overall)} /></th>
                             <th className="px-6 py-5" style={{ width: colWidths.unit }}>Đơn vị <div className="resizer" onMouseDown={(e) => handleResize('unit', e.clientX, colWidths.unit)} /></th>
                             <th className="px-6 py-5 bg-purple-50/20" style={{ width: colWidths.brand }}>Brand Team <div className="resizer" onMouseDown={(e) => handleResize('brand', e.clientX, colWidths.brand)} /></th>
                             <th className="px-6 py-5 bg-orange-50/20" style={{ width: colWidths.operation }}>Operation Team <div className="resizer" onMouseDown={(e) => handleResize('operation', e.clientX, colWidths.operation)} /></th>
                             <th className="px-6 py-5 bg-sky-50/20" style={{ width: colWidths.media }}>Media Team <div className="resizer" onMouseDown={(e) => handleResize('media', e.clientX, colWidths.media)} /></th>
                          </tr>
                          <tr className="bg-white border-b divide-x divide-slate-100">
                             <th className="sticky-col-0"></th>
                             <th className="p-2 sticky-col-1"><input className="w-full p-1.5 text-[9px] border border-slate-100 rounded bg-slate-50 outline-none" placeholder="Lọc ngày..." value={colFilters.date} onChange={e => setColFilters({...colFilters, date: e.target.value})}/></th>
                             <th className="p-2 sticky-col-2"><input className="w-full p-1.5 text-[9px] border border-slate-100 rounded bg-slate-50 outline-none" placeholder="Lọc task..." value={colFilters.task} onChange={e => setColFilters({...colFilters, task: e.target.value})}/></th>
                             <th className="p-2 sticky-col-3 bg-indigo-50/50"><select className="w-full p-1.5 text-[9px] border border-slate-100 rounded bg-slate-50 outline-none font-bold" value={colFilters.overall} onChange={e => setColFilters({...colFilters, overall: e.target.value})}><option value="">Tất cả</option>{OVERALL_STATUS.map(s => <option key={s} value={s}>{s}</option>)}</select></th>
                             <th className="p-2"><input className="w-full p-1.5 text-[9px] border border-slate-100 rounded bg-slate-50 outline-none font-bold" placeholder="Lọc đơn vị..." value={colFilters.unit} onChange={e => setColFilters({...colFilters, unit: e.target.value})}/></th>
                             <th colSpan="3"></th>
                          </tr>
                       </thead>
                       <tbody className="divide-y divide-slate-100">
                          {filteredTasks.map(task => (
                             <tr key={task.id} className="hover:bg-indigo-50/5 transition-colors divide-x divide-slate-100">
                                <td className="px-4 py-4 sticky-col-0 text-center z-20"><button onClick={() => setDeleteModal({ open: true, taskId: task.id, taskName: task.taskName })} className="p-2 text-slate-300 hover:text-rose-600 transition-all rounded-lg hover:bg-rose-50"><Trash2 size={16}/></button></td>
                                <td className="px-6 py-4 sticky-col-1 z-20 text-[10px]"><input type="date" className="w-full border-none bg-transparent font-bold p-0 mb-1 focus:ring-0 outline-none" value={task.orderDate} onChange={e => handleUpdateTask(task.id, {orderDate: e.target.value})} /><select className={`text-[9px] w-full border-none p-0 focus:ring-0 font-black uppercase outline-none ${task.paperStatus === 'Hiệu trưởng duyệt' ? 'text-indigo-600' : task.paperStatus === 'Đã duyệt' ? 'text-emerald-600' : 'text-rose-500'}`} value={task.paperStatus} onChange={e => handleUpdateTask(task.id, {paperStatus: e.target.value})}>{PAPER_STATUS.map(s => <option key={s} value={s}>{s}</option>)}</select></td>
                                <td className="px-6 py-4 sticky-col-2 z-20 !overflow-visible"><input className="text-xs w-full border-none bg-transparent font-black text-slate-900 p-0 mb-1 focus:ring-0 truncate outline-none" value={task.taskName} onChange={e => handleUpdateTask(task.id, {taskName: e.target.value})} /><MultiSelect inline options={CATEGORIES} selected={task.categories} onChange={v => handleUpdateTask(task.id, {categories: v})} /></td>
                                <td className="px-6 py-4 sticky-col-3 z-20 bg-indigo-50/30 text-center"><select className={`text-[10px] w-full border-none bg-transparent p-0 focus:ring-0 font-black uppercase text-center outline-none`} style={{ color: STATUS_COLOR_MAP[task.overallStatus] }} value={task.overallStatus} onChange={e => handleUpdateTask(task.id, {overallStatus: e.target.value})}>{OVERALL_STATUS.map(s => <option key={s} value={s}>{s}</option>)}</select></td>
                                <td className="px-6 py-4"><select className="text-[10px] w-full border-none bg-transparent p-0 font-bold text-slate-600 focus:ring-0 outline-none" value={task.unit} onChange={e => handleUpdateTask(task.id, {unit: e.target.value})}>{DEPARTMENTS.map(d => <option key={d} value={d}>{d}</option>)}</select></td>
                                {['brand', 'operation', 'media'].map(t => (
                                  <td key={t} className={`px-6 py-4 bg-${t === 'brand' ? 'purple' : t === 'operation' ? 'orange' : 'sky'}-50/10`}>
                                     <div className="flex flex-col gap-1.5"><input className="text-[11px] w-full border-none bg-transparent p-0 focus:ring-0 font-black text-slate-700 outline-none" value={task[`${t}Task`].name} onChange={e => handleUpdateTask(task.id, {[`${t}Task`]: {...task[`${t}Task`], name: e.target.value}})} /><div className="flex gap-2"><input type="date" className="text-[9px] border-none bg-transparent p-0 font-black w-1/2 outline-none" value={task[`${t}Task`].deadline} onChange={e => handleUpdateTask(task.id, {[`${t}Task`]: {...task[`${t}Task`], deadline: e.target.value}})} /><select className={`text-[9px] border-none bg-transparent p-0 font-black w-1/2 outline-none ${task[`${t}Task`].status === 'Hoàn thành' ? 'text-emerald-600' : 'text-slate-400'}`} value={task[`${t}Task`].status} onChange={e => handleUpdateTask(task.id, {[`${t}Task`]: {...task[`${t}Task`], status: e.target.value}})}>{TASK_STATUS.map(s => <option key={s} value={s}>{s}</option>)}</select></div><input className="text-[8px] border-none bg-transparent p-0 text-indigo-500 font-bold outline-none italic" value={task[`${t}Task`].link} onChange={e => handleUpdateTask(task.id, {[`${t}Task`]: {...task[`${t}Task`], link: e.target.value}})} placeholder="Link trả..." /></div>
                                  </td>
                                ))}
                             </tr>
                          ))}
                       </tbody>
                    </table>
                 </div>
              </div>
           </div>
        </div>
      </main>
    </div>
  );
}
