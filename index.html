<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>MarCom Dashboard Pro v12.21 (Log & Export)</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/lodash@4.17.21/lodash.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">

    <script async src="https://www.googletagmanager.com/gtag/js?id=G-5WZMXWHSJE"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      gtag('config', 'G-5WZMXWHSJE');
    </script>

    <script type="importmap">
    {
      "imports": {
        "react": "https://esm.sh/react@18.2.0",
        "react-dom": "https://esm.sh/react-dom@18.2.0",
        "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
        "recharts": "https://esm.sh/recharts@2.12.7?external=react,react-dom",
        "lucide-react": "https://esm.sh/lucide-react@0.330.0",
        "firebase/app": "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js",
        "firebase/firestore": "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js",
        "firebase/auth": "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js"
      }
    }
    </script>

    <style>
        body { font-family: 'Inter', sans-serif; -webkit-tap-highlight-color: transparent; }
        .custom-scrollbar::-webkit-scrollbar { height: 6px; width: 6px; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #94a3b8; border-radius: 10px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: #f1f5f9; }
        
        /* FIX STICKY COLUMNS: Added solid background and border-shadow */
        thead th { position: sticky; top: 0; z-index: 40; background-color: #f8fafc; box-shadow: 0 1px 0px #e2e8f0; }
        
        .sticky-col-0, .sticky-col-1, .sticky-col-2, .sticky-col-3, .sticky-col-4 {
            position: sticky;
            z-index: 30; 
            background-color: white !important; /* Force solid white background */
            border-right: 1px solid #e2e8f0;
        }

        thead th.sticky-col-0, thead th.sticky-col-1, thead th.sticky-col-2, thead th.sticky-col-3, thead th.sticky-col-4 {
            z-index: 50 !important; 
            background-color: #f8fafc !important;
        }

        .sticky-col-0 { left: 0; }
        .sticky-col-1 { left: var(--col-width-check, 40px); }
        .sticky-col-2 { left: calc(var(--col-width-check, 40px) + var(--col-width-actions, 50px)); }
        .sticky-col-3 { left: calc(var(--col-width-check, 40px) + var(--col-width-actions, 50px) + var(--col-width-admin, 140px)); }
        .sticky-col-4 { left: calc(var(--col-width-check, 40px) + var(--col-width-actions, 50px) + var(--col-width-admin, 140px) + var(--col-width-task, 250px)); border-right: 2px solid #cbd5e1; box-shadow: 4px 0 6px -1px rgba(0, 0, 0, 0.05); }

        tr:hover td.sticky-col-0, tr:hover td.sticky-col-1, tr:hover td.sticky-col-2, tr:hover td.sticky-col-3, tr:hover td.sticky-col-4 { background-color: #f8fafc !important; }

        .sidebar-transition { transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1); }
        .main-transition { transition: margin-left 0.3s cubic-bezier(0.4, 0, 0.2, 1); }
        
        .tab-content { animation: fadeIn 0.3s ease; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    </style>
</head>
<body class="bg-[#F1F5F9] text-slate-800 h-screen overflow-hidden">
    <div id="root" class="h-full"></div>

    <script type="text/babel" data-type="module">
        import React, { useState, useEffect, useMemo, useRef, useCallback } from 'react';
        import ReactDOM from 'react-dom';
        import { createRoot } from 'react-dom/client';
        import { initializeApp } from 'firebase/app';
        import { getFirestore, collection, addDoc, onSnapshot, updateDoc, doc, serverTimestamp, deleteDoc, writeBatch } from 'firebase/firestore';
        import { getAuth, signInAnonymously, onAuthStateChanged } from 'firebase/auth';
        import { LayoutDashboard, PlusCircle, Table as TableIcon, Download, Upload, Trash2, CheckCircle2, Clock, AlertCircle, X, ChevronDown, Check, Briefcase, Database, Wand2, RefreshCw, Undo2, Redo2, Menu, ChevronLeft, Calendar, Building2, History, FileSpreadsheet } from 'lucide-react';
        import { BarChart, Bar, XAxis, YAxis, Tooltip, ResponsiveContainer, Cell, Legend, PieChart, Pie } from 'recharts';

        // --- CONFIG ---
        const firebaseConfig = {
            apiKey: "AIzaSyDNdBlMZL42nkWc7W1OtgkWvkxKCwxKCjQ",
            authDomain: "marcom-dashboard-test.firebaseapp.com",
            projectId: "marcom-dashboard-test",
            storageBucket: "marcom-dashboard-test.firebasestorage.app",
            messagingSenderId: "840436404750",
            appId: "1:840436404750:web:783b44fa370f94b4dba25f"
        };
        const appId = 'marcom-hub-pro-v12';

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // --- CONSTANTS ---
        const DEPARTMENTS = [ "Văn phòng trường", "P. Marketing và Truyền thông", "P. Đào tạo", "P. Hợp tác quốc tế", "K. Công nghệ thông tin", "K. Cơ khí - Cơ điện tử", "K. Điện - Điện tử", "Toàn trường" ];
        const CATEGORIES = ["Thiết kế", "Duyệt thiết kế", "Trực HT", "Đưa tin", "Chụp ảnh", "Hỗ trợ tổ chức sự kiện", "Khác"];
        const OVERALL_STATUS = ["Chờ duyệt", "Gấp", "Chưa bắt đầu", "Đang xử lý", "Hoàn thành"];
        const TASK_STATUS = ["Không có task", "Chưa bắt đầu", "Đang xử lý", "Hoàn thành"];
        const STATUS_COLOR_MAP = { "Chờ duyệt": "#a855f7", "Gấp": "#ef4444", "Chưa bắt đầu": "#94a3b8", "Đang xử lý": "#6366f1", "Hoàn thành": "#10b981", "Không có task": "#cbd5e1" };

        function App() {
            const [user, setUser] = useState(null);
            const [activeTab, setActiveTab] = useState('dashboard');
            const [tasks, setTasks] = useState([]);
            const [logs, setLogs] = useState([]);
            const [sidebarOpen, setSidebarOpen] = useState(true);
            const [isMobile, setIsMobile] = useState(window.innerWidth < 1024);
            const [selectedIds, setSelectedIds] = useState([]);
            const [history, setHistory] = useState([]);
            const [historyIndex, setHistoryIndex] = useState(-1);
            const [isAiLoading, setIsAiLoading] = useState(false);

            const [colFilters, setColFilters] = useState({ date: '', ticket: '', task: '', overall: '', unit: '' });
            const [globalFilters, setGlobalFilters] = useState({ dateStart: '', dateEnd: '', unit: '', category: '' });
            const [formData, setFormData] = useState({ orderDate: new Date().toISOString().split('T')[0], paperStatus: 'Chưa duyệt', taskName: '', overallStatus: 'Chưa bắt đầu', unit: '', categories: [], brandTask: { name: '', deadline: '', status: 'Chưa bắt đầu' }, operationTask: { name: '', deadline: '', status: 'Chưa bắt đầu' }, mediaTask: { name: '', deadline: '', status: 'Chưa bắt đầu' } });

            // --- AUTH ---
            useEffect(() => {
                signInAnonymously(auth).catch(e => console.error(e));
                return onAuthStateChanged(auth, setUser);
            }, []);

            // --- DATA SYNC & HISTORY ---
            useEffect(() => {
                if (!user) return;
                const unsubTasks = onSnapshot(collection(db, 'marcom_v11_tasks'), (sn) => {
                    const data = sn.docs.map(d => ({ id: d.id, ...d.data() })).sort((a, b) => new Date(b.orderDate) - new Date(a.orderDate));
                    setTasks(data);
                    
                    // Simple Undo logic: Store snapshot if it changed significantly
                    setHistory(prev => {
                        const newHistory = prev.slice(0, historyIndex + 1);
                        return [...newHistory, data].slice(-20); // Keep last 20 steps
                    });
                    setHistoryIndex(prev => prev + 1);
                });

                const unsubLogs = onSnapshot(collection(db, 'marcom_v11_logs'), (sn) => {
                    setLogs(sn.docs.map(d => ({ id: d.id, ...d.data() })).sort((a, b) => b.time - a.time).slice(0, 50));
                });

                return () => { unsubTasks(); unsubLogs(); };
            }, [user]);

            const writeLog = async (action, taskName) => {
                await addDoc(collection(db, 'marcom_v11_logs'), {
                    action,
                    taskName,
                    time: Date.now(),
                    user: "Anonymous User"
                });
            };

            // --- HANDLERS ---
            const handleUpdateTask = async (id, data) => {
                const task = tasks.find(t => t.id === id);
                await updateDoc(doc(db, 'marcom_v11_tasks', id), data);
                writeLog(`Cập nhật: ${Object.keys(data).join(', ')}`, task?.taskName);
            };

            const handleDeleteTask = async (id) => {
                if (!confirm("Xác nhận xóa công việc này?")) return;
                const task = tasks.find(t => t.id === id);
                await deleteDoc(doc(db, 'marcom_v11_tasks', id));
                writeLog("Xóa công việc", task?.taskName);
            };

            const handleUndo = () => {
                if (historyIndex > 0) {
                    // Logic rollback ở đây cần thận trọng với DB thật. 
                    // Trong bản này, Undo chủ yếu phục vụ trải nghiệm UI Local State.
                    alert("Tính năng Hoàn tác cục bộ đang được đồng bộ với Database...");
                    setHistoryIndex(historyIndex - 1);
                }
            };

            const handleExportExcel = () => {
                const exportData = filteredTasks.map(t => ({
                    "Ngày Order": t.orderDate,
                    "Tờ trình": t.paperStatus,
                    "Công việc": t.taskName,
                    "Phân loại": (t.categories || []).join(", "),
                    "Trạng thái tổng": t.overallStatus,
                    "Đơn vị": t.unit,
                    "Brand Task": t.brandTask?.name || "",
                    "Brand DL": t.brandTask?.deadline || "",
                    "Brand Status": t.brandTask?.status || "",
                    "Operation Task": t.operationTask?.name || "",
                    "Operation Status": t.operationTask?.status || "",
                    "Media Task": t.mediaTask?.name || ""
                }));

                const ws = XLSX.utils.json_to_sheet(exportData);
                
                // Auto-fit Columns & Styling
                const colWidths = [];
                Object.keys(exportData[0] || {}).forEach(key => {
                    let maxLen = key.length;
                    exportData.forEach(row => {
                        const val = String(row[key] || "");
                        if (val.length > maxLen) maxLen = val.length;
                    });
                    colWidths.push({ wch: Math.min(maxLen + 2, 50) }); // Max width 50
                });
                ws['!cols'] = colWidths;

                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, "Danh_sach_MarCom");
                XLSX.writeFile(wb, `MarCom_Report_${new Date().toLocaleDateString()}.xlsx`);
            };

            // --- FILTERS ---
            const filteredTasks = useMemo(() => tasks.filter(t => {
                const dateG = (!globalFilters.dateStart || t.orderDate >= globalFilters.dateStart) && (!globalFilters.dateEnd || t.orderDate <= globalFilters.dateEnd);
                const unitG = !globalFilters.unit || t.unit === globalFilters.unit;
                const dateC = !colFilters.date || t.orderDate.includes(colFilters.date);
                const taskC = !colFilters.task || t.taskName?.toLowerCase().includes(colFilters.task.toLowerCase());
                return dateG && unitG && dateC && taskC;
            }), [tasks, globalFilters, colFilters]);

            const chartOverall = OVERALL_STATUS.map(s => ({ name: s, value: filteredTasks.filter(t => t.overallStatus === s).length }));

            return (
                <div className="flex h-full bg-[#F1F5F9]">
                    {/* SIDEBAR */}
                    <aside className={`sidebar-transition fixed inset-y-0 left-0 z-[100] bg-[#0F172A] text-white w-64 ${sidebarOpen ? 'translate-x-0' : '-translate-x-full'}`}>
                        <div className="p-8 border-b border-slate-800 flex items-center gap-3">
                            <Briefcase className="text-indigo-500" />
                            <span className="font-black text-xl uppercase tracking-tighter">MarCom Portal</span>
                        </div>
                        <nav className="p-4 space-y-2">
                            <button onClick={() => setActiveTab('dashboard')} className={`w-full flex items-center gap-4 px-5 py-4 rounded-xl transition-all ${activeTab === 'dashboard' ? 'bg-indigo-600 shadow-lg font-bold' : 'text-slate-400 hover:bg-slate-800'}`}><LayoutDashboard size={18}/> Dashboard</button>
                            <button onClick={() => setActiveTab('list')} className={`w-full flex items-center gap-4 px-5 py-4 rounded-xl transition-all ${activeTab === 'list' ? 'bg-indigo-600 shadow-lg font-bold' : 'text-slate-400 hover:bg-slate-800'}`}><TableIcon size={18}/> Danh sách</button>
                            <button onClick={() => setActiveTab('logs')} className={`w-full flex items-center gap-4 px-5 py-4 rounded-xl transition-all ${activeTab === 'logs' ? 'bg-indigo-600 shadow-lg font-bold' : 'text-slate-400 hover:bg-slate-800'}`}><History size={18}/> Nhật ký Log</button>
                        </nav>
                    </aside>

                    {/* MAIN CONTENT */}
                    <main className={`main-transition flex-1 flex flex-col h-full ${sidebarOpen ? 'ml-64' : 'ml-0'}`}>
                        <header className="p-4 md:p-6 bg-white border-b border-slate-200 flex justify-between items-center sticky top-0 z-[60]">
                            <div className="flex items-center gap-4">
                                <button onClick={() => setSidebarOpen(!sidebarOpen)} className="p-2 bg-slate-100 rounded-full hover:bg-indigo-50 text-slate-600 transition-all">
                                    {sidebarOpen ? <ChevronLeft size={20}/> : <Menu size={20}/>}
                                </button>
                                <h2 className="text-lg md:text-xl font-black uppercase tracking-tight text-slate-800">{activeTab}</h2>
                            </div>
                            
                            <div className="flex items-center gap-3">
                                <div className="flex bg-slate-100 p-1 rounded-lg border border-slate-200">
                                    <button onClick={handleUndo} className="p-2 hover:text-indigo-600" title="Undo"><Undo2 size={18}/></button>
                                    <button className="p-2 text-slate-300" title="Redo"><Redo2 size={18}/></button>
                                </div>
                                <button onClick={handleExportExcel} className="hidden md:flex items-center gap-2 px-4 py-2 bg-emerald-600 text-white rounded-xl font-bold text-xs shadow-lg hover:bg-emerald-700 transition-all">
                                    <FileSpreadsheet size={16}/> Xuất Excel
                                </button>
                            </div>
                        </header>

                        <div className="flex-1 overflow-y-auto p-4 md:p-8 custom-scrollbar">
                            {/* LOG TAB */}
                            {activeTab === 'logs' && (
                                <div className="bg-white rounded-3xl border border-slate-200 shadow-sm p-6 animate-in">
                                    <h3 className="text-lg font-black mb-6 flex items-center gap-2"><History size={20} className="text-indigo-600"/> Lịch sử thay đổi hệ thống</h3>
                                    <div className="space-y-4">
                                        {logs.map(log => (
                                            <div key={log.id} className="flex items-start gap-4 p-4 bg-slate-50 rounded-2xl border border-slate-100 hover:border-indigo-200 transition-all">
                                                <div className="p-2 bg-white rounded-lg shadow-sm text-indigo-600"><Clock size={16}/></div>
                                                <div className="flex-1">
                                                    <div className="flex justify-between"><span className="font-bold text-sm text-slate-800">{log.action}</span><span className="text-[10px] font-bold text-slate-400">{new Date(log.time).toLocaleString()}</span></div>
                                                    <p className="text-xs text-slate-500 mt-1">Nội dung liên quan: <span className="font-bold text-slate-700">{log.taskName || "N/A"}</span></p>
                                                </div>
                                            </div>
                                        ))}
                                    </div>
                                </div>
                            )}

                            {/* DASHBOARD TAB (v12.20 logic) */}
                            {activeTab === 'dashboard' && (
                                <div className="space-y-10 animate-in">
                                    <div className="grid grid-cols-1 md:grid-cols-4 gap-6">
                                        {[{ label: 'Tổng Task', val: tasks.length, color: 'indigo', icon: TableIcon }, { label: 'Hoàn thành', val: tasks.filter(t => t.overallStatus === 'Hoàn thành').length, color: 'emerald', icon: CheckCircle2 }, { label: 'Đang xử lý', val: tasks.filter(t => t.overallStatus === 'Đang xử lý').length, color: 'amber', icon: Clock }, { label: 'Chờ duyệt', val: tasks.filter(t => t.overallStatus === 'Chờ duyệt').length, color: 'rose', icon: AlertCircle }].map((kpi, i) => (
                                            <div key={i} className="bg-white p-7 rounded-3xl shadow-sm border border-slate-200"><div className="w-10 h-10 flex items-center justify-center rounded-xl mb-4 bg-indigo-50 text-indigo-600"><kpi.icon size={20}/></div><h4 className="text-slate-400 text-[10px] font-black uppercase mb-1">{kpi.label}</h4><p className="text-3xl font-black text-slate-900">{kpi.val}</p></div>
                                        ))}
                                    </div>
                                    <div className="bg-white p-8 rounded-3xl border h-[400px] flex flex-col items-center">
                                        <h4 className="text-xs font-black uppercase mb-8 text-slate-400">Trạng thái tổng quát</h4>
                                        <ResponsiveContainer width="100%" height="90%"><BarChart data={chartOverall}><XAxis dataKey="name" style={{fontSize: '9px'}} /><Tooltip /><Bar dataKey="value" barSize={40} radius={[6, 6, 0, 0]}>{chartOverall.map((s, i) => <Cell key={i} fill={STATUS_COLOR_MAP[s.name]} />)}</Bar></BarChart></ResponsiveContainer>
                                    </div>
                                </div>
                            )}

                            {/* LIST TAB (Fixed Sticky Rendering) */}
                            {activeTab === 'list' && (
                                <div className="bg-white rounded-3xl border border-slate-200 h-full flex flex-col overflow-hidden animate-in">
                                    <div className="flex-1 overflow-auto custom-scrollbar">
                                        <table className="table-fixed text-left border-collapse" style={{ width: 'max-content' }}>
                                            <thead>
                                                <tr className="bg-slate-50 text-[10px] font-black uppercase text-slate-400 tracking-widest divide-x divide-slate-200">
                                                    <th className="px-4 py-4 sticky-col-0 text-center"><input type="checkbox" /></th>
                                                    <th className="px-4 py-4 sticky-col-1 text-center">#</th>
                                                    <th className="px-6 py-4 sticky-col-2 w-[140px]">Ngày/Tờ trình</th>
                                                    <th className="px-6 py-4 sticky-col-3 w-[300px]">Nội dung</th>
                                                    <th className="px-6 py-4 sticky-col-4 w-[160px]">Trạng thái tổng</th>
                                                    <th className="px-6 py-4 w-[200px]">Đơn vị</th>
                                                    <th className="px-6 py-4 bg-purple-50 w-[350px]">Brand Team</th>
                                                    <th className="px-6 py-4 bg-orange-50 w-[350px]">Operation Team</th>
                                                    <th className="px-6 py-4 bg-sky-50 w-[350px]">Media Team</th>
                                                </tr>
                                            </thead>
                                            <tbody className="divide-y divide-slate-100 text-xs">
                                                {filteredTasks.map(t => (
                                                    <tr key={t.id} className="hover:bg-slate-50 divide-x divide-slate-100 transition-colors">
                                                        <td className="px-4 py-4 sticky-col-0 text-center"><input type="checkbox" /></td>
                                                        <td className="px-4 py-4 sticky-col-1 text-center"><button onClick={() => handleDeleteTask(t.id)} className="text-slate-300 hover:text-rose-600 transition-all"><Trash2 size={16}/></button></td>
                                                        <td className="px-6 py-4 sticky-col-2"><input type="date" className="bg-transparent font-bold w-full mb-1 outline-none" value={t.orderDate} onChange={e => handleUpdateTask(t.id, {orderDate: e.target.value})}/><div className="text-[9px] uppercase text-slate-400 font-black">{t.paperStatus}</div></td>
                                                        <td className="px-6 py-4 sticky-col-3 font-black text-slate-800 truncate" title={t.taskName}>{t.taskName}</td>
                                                        <td className="px-6 py-4 sticky-col-4 text-center font-bold uppercase tracking-tighter" style={{ color: STATUS_COLOR_MAP[t.overallStatus] }}>{t.overallStatus}</td>
                                                        <td className="px-6 py-4 text-slate-500">{t.unit}</td>
                                                        <td className="px-6 py-4 bg-purple-50/20 font-medium">{t.brandTask?.name || "-"}</td>
                                                        <td className="px-6 py-4 bg-orange-50/20 font-medium">{t.operationTask?.name || "-"}</td>
                                                        <td className="px-6 py-4 bg-sky-50/20 font-medium">{t.mediaTask?.name || "-"}</td>
                                                    </tr>
                                                ))}
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            )}
                        </div>
                    </main>
                </div>
            );
        }

        const root = createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
